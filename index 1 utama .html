<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendaku</title>
  <!-- Prevent cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* CSS tidak ada perubahan dari revisi sebelumnya */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap');
    body {
      background-image: var(--bg-image-url, url('https://files.catbox.moe/sxim3d.jpg'));
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      overflow: hidden;
      min-height: 100vh;
      min-width: 320px;
      font-family: 'Poppins', sans-serif;
      transition: background-image 0.5s ease-in-out;
    }
    .overlay {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }
    #menu.overlay {
        overflow-y: auto;
    }
    .slide {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.97);
      padding: 20px;
      display: none;
      flex-direction: column;
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      overflow-y: auto;
      z-index: 10;
      box-shadow: -5px 0 15px rgba(0,0,0,0.2);
    }
    .slide.active {
      display: flex;
      opacity: 1;
      transform: translateX(0);
    }
    .slide:not(.active) {
      transform: translateX(-20%) scale(0.95);
      opacity: 0;
    }
    input[type="text"], select, input[type="time"] {
      padding: 12px 16px;
      border: 2px solid #ccc;
      border-radius: 10px;
      font-size: 20px;
      width: min(90%, 400px);
      margin-bottom: 20px;
      background: rgba(255,255,255,0.9);
      transition: all 0.3s;
    }
    .btn {
      padding: 15px 30px;
      margin: 10px;
      border: none;
      border-radius: 25px;
      font-size: 18px;
      cursor: pointer;
      width: min(90%, 400px);
      min-width: 200px;
      background: linear-gradient(45deg, #00c853, #2962ff);
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background 0.2s;
    }
    .jadwal-section {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 15px;
    }
    .button-container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 5px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-secondary {
        background: linear-gradient(45deg, #6c757d, #5a6268);
        font-size: 16px;
        margin-top: 5px;
    }
    .btn-secondary:hover {
        background: linear-gradient(45deg, #5a6268, #495057);
    }
    .btn-custom-theme {
        background: linear-gradient(45deg, #9c27b0, #673ab7);
    }
    .btn-custom-theme:hover {
        background: linear-gradient(45deg, #8e24aa, #5e35b1);
    }
    .btn-reset-custom {
      background: linear-gradient(45deg, #ff5722, #f44336);
    }
    .btn-reset-custom:hover {
      background: linear-gradient(45deg, #f44336, #e91e63);
    }
    .btn-edit-save {
      background: linear-gradient(45deg, #ff9800, #ff5722);
    }
    .btn-edit-save:hover {
      background: linear-gradient(45deg, #fb8c00, #f4511e);
    }
    .slide#editJadwal {
      padding-top: 60px;
    }
    .edit-schedule-container {
      flex-grow: 1;
      overflow-y: auto;
      padding-top: 10px;
    }
    .edit-schedule-group {
      margin-bottom: 20px;
      background: rgba(255,255,255,0.85);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .edit-schedule-group h3 {
      color: #0055aa;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .edit-schedule-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
        gap: 8px;
        width: 100%;
        flex-wrap: wrap;
    }
    .edit-schedule-inputs {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .time-input-container {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .time-input-container-specific {
        display: none; /* Default hidden */
        align-items: center;
        gap: 5px;
    }
    .time-input-container-general {
        display: flex; /* Default shown */
        flex-grow: 1;
    }
    .time-input-container-specific input[type="time"] {
        flex-grow: 1;
        width: auto;
        margin-bottom: 0;
        padding: 8px 12px;
        font-size: 16px;
    }
    .time-input-container-general select.time-selector {
        width: 100%;
        flex-grow: 1;
    }
    .description-input-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .description-input-container .activity-input,
    .description-input-container .location-input {
        flex: 1 1 180px; /* Allow wrapping on small screens */
    }
    
    .edit-schedule-item input[type="text"],
    .edit-schedule-item select.time-selector {
      width: 100%;
      margin-bottom: 0;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 8px;
      background: #f9f9f9;
      border: 2px solid #ccc;
    }
    .item-controls {
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
    }
    .item-controls button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      line-height: 1;
      transition: background-color 0.2s, transform 0.2s;
    }
    .item-controls .toggle-time-type-btn { color: #007bff; }
    .item-controls .add-item-btn { color: #28a745; }
    .item-controls .delete-item-btn { color: #dc3545; }
    .item-controls button:hover { transform: scale(1.1); }
    .item-controls .toggle-time-type-btn:hover { background-color: rgba(0, 123, 255, 0.1); }
    .item-controls .add-item-btn:hover { background-color: rgba(40, 167, 69, 0.1); }
    .item-controls .delete-item-btn:hover { background-color: rgba(220, 53, 69, 0.1); }
    
    .edit-schedule-group .add-new-entry {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }
    .edit-schedule-group .add-new-entry input[type="text"] { 
        flex-grow: 1;
        margin-bottom: 0;
    }
    .edit-schedule-group .add-new-entry button {
        flex-shrink: 0;
        padding: 8px 15px;
        font-size: 16px;
        border-radius: 20px;
        background: linear-gradient(45deg, #00c853, #28a745);
        color: white;
        border: none;
        cursor: pointer;
    }
    @media (max-width: 768px) {
      .btn {
        font-size: 16px;
        padding: 12px 24px;
        min-width: 160px;
      }
      .jadwal-section { padding: 10px; }
      h2 { font-size: 1.5rem; }
      .button-container .btn {
          font-size: 12px;
          padding: 8px 10px;
          min-width: unset;
      }
    }
    .slide#info { flex-direction: column; }
    .slide#info .info-header-content { flex-shrink: 0; }
    .slide#info .developer-description-container {
        flex-grow: 1;
        overflow-y: auto;
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-bottom: 15px;
        min-height: 0;
    }
    .slide#info .info-footer-buttons {
        flex-shrink: 0;
        text-align: center;
    }
    h2 {
      margin-bottom: 10px;
      color: #222;
      text-align: center;
    }
    .jadwal-section {
      margin-bottom: 30px;
      flex-grow: 1;
      padding: 10px;
    }
    .jadwal-section h3 {
      color: #0055aa; 
      margin-bottom: 10px;
      background-color: rgba(0, 86, 170, 0.1); 
      padding: 5px 10px; 
      border-radius: 5px;
    }
    .jadwal-section ul { 
      list-style: none;
      padding-left: 0; 
      margin-bottom: 15px;
    }
    .jadwal-section ul li {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 3px 5px;
        line-height: 1.5;
        margin-bottom: 6px;
        margin-left: 0;
    }
    .jadwal-section ul li:nth-child(odd):not(.selesai) { 
      background-color: rgba(0, 200, 83, 0.1);
    }
    .jadwal-section ul li:nth-child(even):not(.selesai) { 
      background-color: rgba(41, 98, 255, 0.1);
    }
    .jadwal-checkbox {
        width: 22px;
        height: 22px;
        border: 2px solid #0055aa;
        border-radius: 5px;
        cursor: pointer;
        flex-shrink: 0;
        position: relative;
        transition: background-color 0.2s, border-color 0.2s;
    }
    li.selesai {
        background-color: #f0f0f0 !important;
    }
    li.selesai .jadwal-checkbox {
        background-color: #00c853;
        border-color: #00c853;
    }
    li.selesai .jadwal-checkbox::after {
        content: '✓';
        color: white;
        font-size: 16px;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
    }
    .jadwal-teks {
        transition: opacity 0.3s, text-decoration 0.3s;
        word-break: break-word;
    }
    .location-text {
        font-style: italic;
        color: #0055aa;
        margin-left: 5px;
    }
    li.selesai .jadwal-teks {
        text-decoration: line-through;
        opacity: 0.6;
    }
    .popup-overlay {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%;
      height: 100%; 
      background: rgba(0,0,0,0.6);
      display: flex; 
      justify-content: center; 
      align-items: center;
      z-index: 2000; 
      opacity: 0; 
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #quotePopup.popup-overlay.active .popup-content {
        transform: scale(1);
    }
    #quotePopup .popup-content {
        transform: scale(0.7);
        transition: transform 0.3s ease;
    }
    .popup-overlay.active { 
      opacity: 1; 
      pointer-events: auto;
    }
    .popup-content {
      background: white; 
      border-radius: 15px; 
      width: 90%; 
      max-width: 500px;
      padding: 20px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: translateY(20px); 
      transition: transform 0.3s ease, opacity 0.3s ease;
      text-align: center;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .popup-overlay.active .popup-content { 
      transform: translateY(0); 
    }
    .popup-content .popup-header {
      color: #0055aa;
      margin-bottom: 15px; 
      text-align: center;
      border-bottom: 2px solid #0055aa; 
      padding-bottom: 10px;
      flex-shrink: 0;
    }
    .popup-content .popup-body {
      overflow-y: auto;
      flex-grow: 1;
      text-align: left;
    }
     .popup-content .popup-body.centered {
        text-align: center;
    }
    .popup-content .popup-footer {
        margin-top: 15px;
        flex-shrink: 0;
    }
    .popup-close-btn {
      position: absolute;
      top: 10px;
      right: 10px; 
      background: none;
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      color: #666; 
      z-index: 1;
    }
    /* --- Styles for Quote Popup --- */
    .quote-popup-content {
        padding: 30px;
        background: #fdfdfd;
    }
    .quote-popup-content blockquote {
        margin: 0;
        position: relative;
    }
    .quote-popup-content blockquote::before {
        content: '"';
        font-family: 'Merriweather', serif;
        position: absolute;
        top: -20px;
        left: -25px;
        font-size: 60px;
        color: rgba(0, 0, 0, 0.1);
        line-height: 1;
    }
    #quotePopupText {
        font-family: 'Merriweather', serif;
        font-size: 1.25em;
        font-style: italic;
        line-height: 1.6;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
    }
    #quotePopupAuthor {
        font-family: 'Poppins', sans-serif;
        font-size: 1em;
        font-weight: 600;
        color: #555;
        text-align: right;
        margin-top: 15px;
    }
    /* --- End Quote Popup Styles --- */
    .popup-content.notification-popup .popup-body {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      text-align: left;
    }
    @media (min-width: 600px) {
      .popup-content.notification-popup .popup-body {
        grid-template-columns: 1fr 1fr;
      }
    }
    .popup-content.notification-popup .jadwal-group {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }
    .popup-content.notification-popup .jadwal-group h4 {
      color: #0055aa;
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      text-align: center;
    }
    .popup-content.notification-popup .jadwal-group ul {
      list-style: none;
      padding: 0;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .popup-content.notification-popup .jadwal-group ul li {
      margin-bottom: 5px;
      padding: 3px 0;
      line-height: 1.4;
    }
    .popup-content.notification-popup .jadwal-group ul li.popup-selesai .popup-jadwal-teks {
        text-decoration: line-through;
        color: #777;
    }
    .popup-content.notification-popup .no-schedule-message {
        text-align: center;
        color: #757575;
        font-style: italic;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    #toast-container {
        position: fixed;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        max-width: 90%;
    }
    .toast-wrapper {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 24px rgba(0,0,0,0.15);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        max-width: 360px;
        min-width: 280px;
        word-break: break-word;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-30px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .toast-wrapper.entering {
        opacity: 1; 
        transform: translateY(0);
    }
    .bell-icon {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
        fill: #007aff;
        transition: fill 0.3s ease;
    }
    .toast-content {
        flex: 1;
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform: translateX(0);
        opacity: 1;
    }
    .toast-content strong {
        font-size: 15px;
        color: #111;
        margin-bottom: 4px;
        display: block;
    }
    .toast-content span {
        font-size: 14px;
        color: #333;
        line-height: 1.4;
        display: block;
    }
    .circular-btn {
        position: fixed;
        width: 55px; 
        height: 55px;
        background-color: #000000;
        border-radius: 50%; 
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        display: flex; 
        justify-content: center;
        align-items: center;
        transition: transform 0.2s ease;
        z-index: 100; 
        right: 20px; 
        font-size: 28px; 
        color: white;
    }
    .circular-btn:hover { 
      transform: scale(1.1); 
    }
    .home-btn { 
      bottom: 20px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFFFFF"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>'); 
      background-size: 60%; 
      background-repeat: no-repeat; 
      background-position: center;
    }
    .quote-btn { 
      bottom: 85px; 
    }
    .quote-btn::before { 
      content: "💬"; 
      font-size: 28px; 
      color: white;
    }
    .tutorial-help-btn { 
      bottom: 150px; 
    }
    .tutorial-help-btn::before { 
      content: "💡"; 
      font-size: 28px; 
      color: white;
    }
    .help-btn {
      bottom: 20px;
      left: 20px;
      background-color: #2196f3;
      font-size: 28px;
      font-weight: bold;
      color: white;
      line-height: 1;
    }
    .button-container .btn { 
      padding: 8px 15px; 
      margin: 0;
      font-size: 14px; 
      border-radius: 20px; 
      flex-grow: 1; 
      min-width: 70px; 
    }
    .button-container .btn:active { 
      transform: scale(0.95);
    }
    .tutorial-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%;
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 3000;
    }
    .tutorial-popup { 
      background: white; 
      border-radius: 15px; 
      width: 90%;
      max-width: 400px; 
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
      position: relative; 
    }
    .tutorial-close { 
      position: absolute;
      top: 10px; 
      right: 10px;
      background: none; 
      border: none; 
      font-size: 20px; 
      cursor: pointer; 
      color: #666;
    }
    #helpPopupOverlay {
      z-index: 3000;
    }
    #helpPopupContent {
      max-width: 500px;
    }
    #helpPopupContent ul {
        list-style: none;
        padding-left: 20px;
        margin-top: 10px;
        text-align: left;
    }
    #helpPopupContent ul li {
        margin-bottom: 8px;
        line-height: 1.4;
    }
    #helpPopupContent strong {
        color: #0055aa;
    }
    .slide#info .btn {
    }
    .slide#info .btn-contact-admin {
      background: linear-gradient(45deg, #4CAF50, #8BC34A);
      margin-bottom: 0;
    }
    .slide#info .btn-contact-admin:hover { 
      background: linear-gradient(45deg, #5cb85c, #9ccc65);
    }
    .btn-kritik-saran {
      background: linear-gradient(45deg, #FF9800, #FF5722) !important;
      color: white !important;
    }
    .btn-kritik-saran:hover {
      background: linear-gradient(45deg, #fb8c00, #f4511e) !important;
    }
    .reset-confirm-popup .question-mark,
    .theme-confirm-popup .question-mark,
    .default-theme-confirm-popup .question-mark,
    .save-confirm-popup .question-mark,
    .exit-confirm-popup .question-mark,
    .delete-confirm-popup .question-mark,
    .pdf-confirm-popup .question-mark { 
        font-size: 60px; 
        display: block; 
        margin-bottom: 15px;
    }
    .reset-confirm-popup .question-mark { color: red; }
    .theme-confirm-popup .question-mark { color: #2196f3; }
    .default-theme-confirm-popup .question-mark { color: #2196f3; }
    .save-confirm-popup .question-mark { color: #FFA500; }
    .exit-confirm-popup .question-mark { color: #ffc107; }
    .delete-confirm-popup .question-mark { color: #dc3545; }
    .pdf-confirm-popup .question-mark { color: #4CAF50; }
    #kritikSaranPopup textarea {
        width: 100%;
        min-height: 120px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-size: 16px;
        resize: vertical;
        margin-bottom: 15px;
        box-sizing: border-box;
    }
    #kritikSaranPopup .feedback-fallback {
        font-size: 14px;
        text-align: left;
        color: #555;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 8px;
        margin-top: 15px;
        word-wrap: break-word;
    }
    #kritikSaranPopup .btn-copy-email {
        background: linear-gradient(45deg, #607D8B, #455A64);
        padding: 8px 15px;
        font-size: 14px;
        min-width: 100px;
        margin-left: 10px;
    }
    #kritikSaranPopup .feedback-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    #kritikSaranPopup .btn-confirm-container {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        flex-wrap: wrap;
    }
    #kritikSaranPopup .btn-confirm {
        padding: 10px 20px;
        font-size: 16px;
        min-width: 100px;
        flex-grow: 1;
    }
    #kritikSaranPopup .btn-kirim {
        background: linear-gradient(45deg, #00c853, #00e676);
    }
    #kritikSaranPopup .btn-batal {
        background: linear-gradient(45deg, #f44336, #ff5722);
    }
    .reset-confirm-popup p,
    .theme-confirm-popup p,
    .default-theme-confirm-popup p,
    .save-confirm-popup p,
    .exit-confirm-popup p,
    .delete-confirm-popup p,
    .pdf-confirm-popup p,
    #helpPopupContent p {
        font-size: 16px; 
        color: #333; 
        margin-bottom: 20px;
    }
    .reset-confirm-popup .btn-confirm-container,
    .theme-confirm-popup .btn-confirm-container,
    .default-theme-confirm-popup .btn-confirm-container,
    .save-confirm-popup .btn-confirm-container,
    .exit-confirm-popup .btn-confirm-container,
    .delete-confirm-popup .btn-confirm-container,
    .pdf-confirm-popup .btn-confirm-container,
    #helpPopupContent .popup-footer .btn {
        display: flex; 
        justify-content: space-around;
        gap: 10px;
        flex-wrap: wrap;
    }
    .reset-confirm-popup .btn-confirm,
    .theme-confirm-popup .btn-confirm,
    .default-theme-confirm-popup .btn-confirm,
    .save-confirm-popup .btn-confirm,
    .exit-confirm-popup .btn-confirm,
    .delete-confirm-popup .btn-confirm,
    .pdf-confirm-popup .btn-confirm {
        padding: 10px 20px; 
        font-size: 16px; 
        min-width: 100px;
        flex-grow: 1;
    }
    .reset-confirm-popup .btn-yes,
    .theme-confirm-popup .btn-yes,
    .default-theme-confirm-popup .btn-yes,
    .save-confirm-popup .btn-yes,
    .exit-confirm-popup .btn-yes,
    .delete-confirm-popup .btn-yes,
    .pdf-confirm-popup .btn-yes {
        background: linear-gradient(45deg, #00c853, #00e676);
    }
    .reset-confirm-popup .btn-no,
    .theme-confirm-popup .btn-no,
    .default-theme-confirm-popup .btn-no,
    .save-confirm-popup .btn-no,
    .exit-confirm-popup .btn-no,
    .delete-confirm-popup .btn-no,
    .pdf-confirm-popup .btn-no {
        background: linear-gradient(45deg, #f44336, #ff5722);
    }
    .save-confirm-popup .btn-cancel {
        background: linear-gradient(45deg, #9E9E9E, #616161);
    }
    .background-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px 0;
      overflow-y: auto;
      max-height: calc(100vh - 250px); /* Adjusted for custom button */
      align-items: center;
    }
    .background-grid img {
      width: 100%;
      max-width: 300px;
      height: 150px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border 0.3s;
      border-radius: 10px;
    }
    .background-grid img:hover {
      border: 2px solid #888;
    }
    .custom-theme-container {
        padding: 20px 0;
        text-align: center;
        border-top: 1px solid #eee;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
    }
    .copyright-info {
        text-align: center;
        color: #666;
        font-size: 12px;
        padding: 10px;
        margin-top: 20px;
        border-top: 1px solid #eee;
    }
    .copyright-info::before { 
      content: "©2025 amiieen_All rights reserved"; 
      margin-right: 5px;
    }
    .info-frame { 
      position: fixed; 
      padding: 10px 15px; 
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
      font-size: 14px;
      font-weight: bold; 
      z-index: 50; 
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background: linear-gradient(45deg, #00c853, #2962ff); 
      color: #FFFFFF;
      font-style: italic; 
      font-weight: 600; 
    }
    .info-frame:hover { 
      transform: scale(1.02);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .digital-time { 
      top: 20px; 
      left: 20px; 
      right: unset;
    }
    .user-info { 
      top: 80px;
      left: 20px; 
      right: unset; 
      display: none;
    }
    .user-info span { 
      display: block; 
      line-height: 1.2;
    }
    .jadwal-empty { 
      color: #757575;
      padding: 20px; 
      text-align: center; 
      font-style: italic;
    }
    .slide#instruksi .tutorial-content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
    }
    .tutorial-section { margin-bottom: 30px; }
    .tutorial-section h3 {
      color: #0055aa;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 2px solid #0055aa;
    }
    .tutorial-section ul {
      list-style-type: none;
      padding-left: 0;
    }
    .tutorial-section > ul > li {
      margin-bottom: 10px;
      padding-left: 15px;
      border-left: 3px solid #00c853;
      list-style-type: none;
    }
     .tutorial-section ul ul {
        margin-top: 10px;
        padding-left: 20px;
     }
    .tutorial-section ul ul li {
        border-left: 3px solid #ff9800;
        font-size: 0.95em;
    }
    .tutorial-section li strong { color: #0055aa; }
    #agendakuSidebar {
        position: fixed;
        top: 0;
        right: 0;
        width: min(70vw, 320px);
        height: 100vh;
        background: rgba(20, 20, 20, 0.95);
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        padding: 20px;
        transform: translateX(100%);
        transition: transform 0.35s ease-out;
        z-index: 1000;
    }
    #agendakuSidebar.active {
        transform: translateX(0);
    }
    .sidebar-overlay-blur {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.2);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.35s ease-out;
    }
    .sidebar-overlay-blur.active {
        opacity: 1;
        pointer-events: auto;
    }
    #agendakuSidebar .sidebar-header h3,
    #agendakuSidebar .sidebar-content,
    #agendakuSidebar .sidebar-footer {
        color: #f0f0f0;
    }
    #agendakuSidebar .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    #agendakuSidebar .sidebar-header h3 {
        margin: 0;
    }
    #agendakuSidebar .sidebar-close-btn {
        background: none;
        border: none;
        font-size: 28px;
        font-weight: bold;
        color: #f0f0f0;
        cursor: pointer;
        padding: 0 5px;
    }
    #agendakuSidebar .sidebar-content h4 {
        color: #4dabf7;
        margin-top: 20px;
    }
    #agendakuSidebar .sidebar-footer {
        border-top: 1px solid #444;
        margin-top: auto;
        padding-top: 15px;
        font-size: 0.9em;
    }
    #agendakuSidebar .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        line-height: 1.6;
    }
    #agendakuSidebar .sidebar-content p {
        margin-bottom: 10px;
        color: #ccc;
    }
    .update-info-toggle {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        user-select: none;
        color: #4dabf7;
    }
    .update-info-toggle .arrow {
        transition: transform 0.3s ease;
        font-size: 14px;
    }
    .update-info-toggle.open .arrow {
        transform: rotate(180deg);
    }
    .update-info-content {
        padding-left: 15px;
        border-left: 2px solid #4dabf7;
        margin: 10px 0;
        line-height: 1.5;
        display: none;
        color: #ddd;
    }
    .update-info-content strong { color: #f0f0f0; }
    .update-info-content ul {
        list-style-type: '✓  ';
        padding-left: 20px;
        margin: 0;
    }
    .update-info-content li { margin-bottom: 8px; }
    .menu-icon-top-right {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #00c853, #2962ff);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.3s ease;
      z-index: 101;
    }
    .menu-icon-top-right:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .menu-icon-top-right::before {
        content: "☰"; /* Ikon hamburger */
    }
    .btn-keluar-sidebar {
        width: 100%;
        padding: 10px;
        margin: 15px 0;
        font-size: 16px;
        border-radius: 10px;
        background: linear-gradient(45deg, #c62828, #f44336);
        color: white;
        border: none;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
    }
    .btn-keluar-sidebar:hover {
        background: linear-gradient(45deg, #d32f2f, #e53935);
        transform: scale(1.02);
    }
    .social-icons-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 15px 0;
        border-top: 1px solid #444;
        margin-top: 15px;
        flex-shrink: 0;
    }
    .social-icon {
        width: 40px;
        height: 40px;
        background-color: #333;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .social-icon:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background-color: #007bff;
    }
    .social-icon svg {
        width: 24px;
        height: 24px;
        fill: #fff;
    }
    .sidebar-action-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 20px 0;
        padding: 15px 0;
        border-top: 1px solid #444;
        border-bottom: 1px solid #444;
    }
    .btn-sidebar-action {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: white;
        text-decoration: none;
    }
    .btn-sidebar-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .btn-new-update {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    }
    .btn-new-update:hover {
        background: linear-gradient(45deg, #ff5252, #f44336);
    }
    .btn-export-project {
        background: linear-gradient(45deg, #4caf50, #45a049);
    }
    .btn-export-project:hover {
        background: linear-gradient(45deg, #45a049, #4caf50);
    }
    .btn-import-project {
        background: linear-gradient(45deg, #2196f3, #1976d2);
    }
    .btn-import-project:hover {
        background: linear-gradient(45deg, #1976d2, #1565c0);
    }
    .btn-export-pdf {
        background: linear-gradient(45deg, #ff9800, #f57c00);
    }
    .btn-export-pdf:hover {
        background: linear-gradient(45deg, #f57c00, #ef6c00);
    }
    .hidden-file-input {
        display: none;
    }

    /* Enhanced Export/Import Popup Styles */
    .export-popup .popup-content,
    .import-popup .popup-content {
        max-width: 600px;
        width: 95%;
        max-height: 85vh;
    }

    .export-popup .popup-body, 
    .import-popup .popup-body {
        text-align: left;
        padding: 0;
    }

    .export-data-display {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-all;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.08);
        position: relative;
    }

    .export-data-display::before {
        content: "📋 Data Backup";
        position: absolute;
        top: -10px;
        left: 15px;
        background: white;
        padding: 0 10px;
        font-size: 12px;
        font-weight: bold;
        color: #495057;
        font-family: 'Poppins', sans-serif;
    }

    .io-instructions {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border: 2px solid #b3e5fc;
        color: #01579b;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .io-instructions h4 {
        color: #0277bd;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .io-instructions h4::before {
        content: "📖";
        font-size: 20px;
    }

    .io-instructions ol {
        padding-left: 25px;
        margin: 0;
        line-height: 1.8;
    }

    .io-instructions li {
        margin-bottom: 12px;
        position: relative;
    }

    .io-instructions li strong {
        background: rgba(255,255,255,0.7);
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
    }

    #importDataTextarea {
        width: 100%;
        height: 200px;
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
        resize: vertical;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.08);
        margin-top: 15px;
        transition: border-color 0.3s ease;
        background: #f8f9fa;
    }

    #importDataTextarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.08), 0 0 0 3px rgba(0,123,255,0.1);
    }

    #importDataTextarea::placeholder {
        color: #6c757d;
        font-style: italic;
    }

    .import-popup .popup-footer {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .import-popup .popup-footer .btn,
    .export-popup .popup-footer .btn {
        flex: 1;
        min-width: 120px;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .export-popup .popup-footer {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    /* Mobile Responsive Improvements */
    @media (max-width: 768px) {
        .export-popup .popup-content,
        .import-popup .popup-content {
            width: 98%;
            max-height: 90vh;
            margin: 10px;
        }

        .io-instructions {
            padding: 15px;
        }

        .io-instructions h4 {
            font-size: 16px;
        }

        .export-data-display {
            padding: 15px;
            font-size: 12px;
            max-height: 250px;
        }

        #importDataTextarea {
            height: 150px;
            padding: 12px;
            font-size: 12px;
        }

        .import-popup .popup-footer .btn,
        .export-popup .popup-footer .btn {
            min-width: 100px;
            padding: 10px 15px;
            font-size: 14px;
        }
    }

    @media (max-width: 480px) {
        .export-popup .popup-content,
        .import-popup .popup-content {
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
            margin: 0;
        }

        .io-instructions ol {
            padding-left: 20px;
        }

        .import-popup .popup-footer,
        .export-popup .popup-footer {
            flex-direction: column;
            gap: 10px;
        }

        .import-popup .popup-footer .btn,
        .export-popup .popup-footer .btn {
            width: 100%;
        }
    }

    /* PDF Success Popup Styles */
    .pdf-success-popup .popup-body {
        text-align: center;
    }
    .pdf-link-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        margin: 15px 0;
        background: #f9f9f9;
        font-family: 'Courier New', monospace;
        word-break: break-all;
    }
    .pdf-download-link {
        display: inline-block;
        margin: 10px 0;
        padding: 12px 20px;
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: bold;
        transition: transform 0.2s ease, background 0.2s ease;
    }
    .pdf-download-link:hover {
        background: linear-gradient(45deg, #45a049, #388e3c);
        transform: translateY(-2px);
    }

  
/* Pop-up Sambutan */
.popup-content.welcome-popup-content {
  background: linear-gradient(135deg, #00c853, #2962ff);
  color: white;
  border-radius: 20px;
  padding: 30px 20px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  font-family: 'Poppins', sans-serif;
  transform: scale(0.8);
  transition: transform 0.3s ease, opacity 0.3s ease;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  position: relative;
}
#welcomePopup.active .welcome-popup-content {
  transform: scale(1);
}
#welcomePopup h2 {
  font-size: 24px;
  margin-bottom: 15px;
}
#welcomePopup p {
  font-size: 16px;
  margin-bottom: 25px;
  line-height: 1.5;
}
.btn.btn-welcome {
  background: white;
  color: #2962ff;
  font-weight: bold;
  font-size: 16px;
  padding: 12px 25px;
  border-radius: 30px;
  border: none;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
}
.btn.btn-welcome:hover {
  background: #f0f0f0;
  transform: scale(1.05);
}
#welcomePopup {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
#welcomePopup.active {
  opacity: 1;
  pointer-events: auto;
}
#welcomePopup .popup-close-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  font-size: 26px;
  font-weight: bold;
  color: white;
  cursor: pointer;
}

</style>
</head>
<body>

  <div class="sidebar-overlay-blur" id="sidebarOverlay"></div>
  
  <div class="overlay" id="login">
    <input type="text" id="nama" placeholder="Masukkan Nama Anda">
    <input type="text" id="nimInput" placeholder="Masukkan Nim/Kelas (Opsional)">
    <button class="btn" id="loginBtn">Masuk</button>
    <button class="btn btn-secondary" id="guestLoginBtn">Masuk sebagai Tamu</button>
    <div class="digital-time info-frame" id="digitalClock"></div>
    <div class="user-info info-frame" id="userInfoDisplayLogin">
      <span id="userNameDisplayLogin"></span>
      <span id="userNimDisplayLogin"></span>
    </div>
    <div class="menu-icon-top-right" onclick="showAgendakuBranding()"></div>
  </div>

  <div class="overlay" id="menu" style="display:none">
    <button class="btn" onclick="bukaSlide('jadwal')">Jadwal Kegiatan</button>
    <button class="btn" onclick="bukaSlide('kuliah')">Jadwal Kuliah/Sekolah</button>
    <button class="btn" onclick="bukaSlide('ubahTema')">Ganti Tema Aplikasi</button>
    <button class="btn" onclick="bukaSlide('catatan')">Buat Catatan</button> 
    <button class="btn" onclick="bukaSlide('info')">Info</button>
    <div class="digital-time info-frame" id="digitalClockMenu"></div>
    <div class="user-info info-frame" id="userInfoDisplayMenu">
      <span id="userNameDisplayMenu"></span>
      <span id="userNimDisplayMenu"></span>
    </div>
    <div class="menu-icon-top-right" onclick="showAgendakuBranding()"></div>
  </div>

  <div class="slide" id="jadwal">
    <div class="button-container">
      <button class="btn btn-edit-save" onclick="bukaSlide('editJadwal', 'jadwalContent')">Edit</button>
      <button class="btn btn-reset-custom" onclick="confirmResetSchedule('jadwalContent')">Reset</button>
      <button class="btn" onclick="tutupSlide('jadwal')">Kembali</button>
    </div>
    <h2>Kegiatan Harian</h2> <div class="jadwal-section" id="jadwalContainer">
      <div id="jadwalContent">
        </div>
    </div>
  </div>

  <div class="slide" id="kuliah">
    <div class="button-container">
      <button class="btn btn-edit-save" onclick="bukaSlide('editJadwal', 'kuliahContent')">Edit</button>
      <button class="btn btn-reset-custom" onclick="confirmResetSchedule('kuliahContent')">Reset</button>
      <button class="btn" onclick="tutupSlide('kuliah')">Kembali</button>
    </div>
    <h2>Jadwal Kuliah/ Sekolah</h2>
    <div id="kuliahContent" class="jadwal-section">
      </div>
  </div>

  <div class="slide" id="ubahTema">
    <div class="button-container">
      <button class="btn" onclick="tutupSlide('ubahTema')">Kembali</button>
      <button class="btn btn-reset-custom" onclick="confirmDefaultTheme()">Tema Default</button> 
    </div>
    <h2>Pilih Tema Latar Belakang</h2>
    <div class="background-grid">
      <img src="https://files.catbox.moe/xtcb9j.jpg" onclick="confirmImageTheme('https://files.catbox.moe/xtcb9j.jpg')" alt="Latar 1" />
      <img src="https://files.catbox.moe/m34hwi.jpg" onclick="confirmImageTheme('https://files.catbox.moe/m34hwi.jpg')" alt="Latar 2" />
      <img src="https://files.catbox.moe/7kizkm.jpg" onclick="confirmImageTheme('https://files.catbox.moe/7kizkm.jpg')" alt="Latar 3" />
      <img src="https://files.catbox.moe/6inu37.jpg" onclick="confirmImageTheme('https://files.catbox.moe/6inu37.jpg')" alt="Latar 4" />
      <img src="https://files.catbox.moe/mq9zmw.jpg" onclick="confirmImageTheme('https://files.catbox.moe/mq9zmw.jpg')" alt="Latar 5" />
      <img src="https://files.catbox.moe/mhhmd9.jpg" onclick="confirmImageTheme('https://files.catbox.moe/mhhmd9.jpg')" alt="Latar 6" />
      <img src="https://files.catbox.moe/60s2gr.jpg" onclick="confirmImageTheme('https://files.catbox.moe/60s2gr.jpg')" alt="Latar 7" />
      <img src="https://files.catbox.moe/29u9l1.jpg" onclick="confirmImageTheme('https://files.catbox.moe/29u9l1.jpg')" alt="Latar 8" />
      <img src="https://files.catbox.moe/dp6gal.jpg" onclick="confirmImageTheme('https://files.catbox.moe/dp6gal.jpg')" alt="Latar 9" />
      <img src="https://files.catbox.moe/2juexf.jpg" onclick="confirmImageTheme('https://files.catbox.moe/2juexf.jpg')" alt="Latar 10" />
    </div>
    <div class="custom-theme-container">
        <button class="btn btn-custom-theme" onclick="triggerCustomTheme()">Unggah Tema Custom</button>
    </div>
  </div>

  <div class="slide" id="catatan">
    <div class="button-container">
      <button class="btn btn-edit-save" onclick="bukaSlide('editCatatan')">Edit</button>
      <button class="btn" onclick="tutupSlide('catatan')">Kembali</button>
    </div>
    <h2>Catatan Pribadi</h2>
    <div id="catatanContent" class="jadwal-section" style="flex-grow: 1; overflow-y: auto;">
      </div>
  </div>

  <div class="slide" id="editCatatan">
    <div class="button-container">
      <button class="btn btn-edit-save" onclick="saveCatatan()">Simpan</button>
      <button class="btn" onclick="tutupSlide('editCatatan')">Kembali</button>
    </div>
    <h2>Edit Catatan Pribadi</h2>
    <textarea id="editCatatanTextarea" style="width: 100%; height: 100%; border: 1px solid #ccc; padding: 15px; font-size: 16px; border-radius: 10px; resize: vertical; box-sizing: border-box; flex-grow: 1;"></textarea>
  </div>

  <div class="slide" id="info">
    <div class="info-header-content">
      <h2>Info Pengguna</h2>
      <p id="namaInfo">Nama: -</p>
      <p id="nimInfo">Nim/Kelas: -</p>
    </div>
    <div class="developer-description-container" id="developerDescriptionScrollable">
        <h3>Sebuah Pesan dari Developer</h3>
        <p style="margin-top: 10px;">
            Halo Pengguna Agendaku,
        </p>
        <p>
            Terima kasih telah memilih dan menggunakan aplikasi ini. Agendaku dibuat dengan tujuan sederhana: membantu Anda mengelola jadwal harian dengan lebih mudah dan efisien. Saya sadar bahwa aplikasi ini masih dalam tahap pengembangan dan jauh dari kata sempurna. Mungkin Anda akan menemukan bug atau kekurangan di beberapa fitur.
        </p>
        <p>
            Untuk itu, saya memohon maaf atas segala ketidaknyamanan yang mungkin timbul. Setiap masukan, kritik, dan saran dari Anda sangatlah berharga bagi saya untuk terus memperbaiki dan mengembangkan Agendaku menjadi lebih baik. Jangan ragu untuk menghubungi saya melalui tombol "Kritik dan Saran".
        </p>
        <p>
            Sekali lagi, terima kasih atas dukungan Anda. Semoga aplikasi ini bermanfaat!
        </p>
        <p>Hormat saya,<br><strong>#Amin FA</strong></p>
    </div>
    <div class="info-footer-buttons">
      <button class="btn" onclick="bukaSlide('instruksi')" style="margin-top: 20px;">Panduan Aplikasi</button>
      <button class="btn" onclick="tutupSlide('info')">Kembali</button>
      <button class="btn btn-kritik-saran" onclick="showKritikSaranPopup()">Kritik dan Saran</button>
      <div class="copyright-info">•</div>
    </div>
  </div>

  <div class="slide" id="instruksi">
    <div class="button-container">
        <button class="btn" onclick="tutupSlide('instruksi')">Kembali ke Info</button>
    </div>
    <h2>Panduan Penggunaan Aplikasi</h2>
    <div class="tutorial-content">
        <div class="tutorial-section">
            <h3>Selamat Datang di Agendaku!</h3>
            <p>Aplikasi ini dirancang untuk menjadi asisten pribadi Anda dalam mengatur jadwal kegiatan, perkuliahan/sekolah, dan catatan penting. Mari kita mulai!</p>
        </div>

        <div class="tutorial-section">
            <h3>Memulai Aplikasi</h3>
            <ul>
                <li><strong>Login Pengguna:</strong> Masukkan nama Anda untuk personalisasi. Data Anda akan disimpan secara lokal di browser Anda.</li>
                <li><strong>Mode Tamu:</strong> Jika Anda hanya ingin mencoba, gunakan "Masuk sebagai Tamu". Tidak ada data yang akan disimpan secara permanen dengan nama Anda.</li>
            </ul>
        </div>
        
        <div class="tutorial-section">
            <h3>Mengelola Tema Latar</h3>
            <ul>
                <li><strong>Pilih Tema:</strong> Masuk ke menu "Ganti Tema Aplikasi" untuk memilih dari daftar latar belakang yang tersedia.</li>
                <li><strong>Tema Custom:</strong>
                    <ul>
                       <li>Di bagian bawah halaman tema, klik tombol "Unggah Tema Custom".</li>
                       <li>Pilih gambar dari perangkat Anda. <strong>Disarankan menggunakan gambar dengan orientasi potrait (tegak)</strong> agar tampilan optimal di perangkat mobile.</li>
                       <li>Konfirmasi untuk menerapkan tema baru Anda.</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="tutorial-section">
            <h3>Mengelola Jadwal Anda</h3>
            <ul>
                <li><strong>Edit:</strong> Klik tombol "Edit" untuk masuk ke mode pengeditan. Jadwal kini memiliki template awal untuk memudahkan Anda.</li>
                <li><strong>Mode Waktu Fleksibel:</strong> Gunakan ikon ⏱️/🗓️ di samping setiap item untuk beralih antara waktu spesifik (misal: 08.00-09.00) dan waktu umum (misal: Pagi, Siang).</li>
                <li><strong>Lokasi:</strong> Tambahkan detail tempat atau lokasi pada kolom yang tersedia.</li>
                <li><strong>Simpan & Reset:</strong> Jangan lupa "Simpan" perubahan Anda. Tombol "Reset" akan mengembalikan jadwal ke template awal.</li>
            </ul>
        </div>

        <div class="tutorial-section">
            <h3>Backup Data (Export/Import)</h3>
            <ul>
                <li><strong>Export Project:</strong> Buka menu samping (☰) dan pilih "Export Project". Salin kode yang muncul dan simpan di tempat aman (misal: file .txt). Ini adalah cadangan seluruh data Anda.</li>
                <li><strong>Import Project:</strong> Untuk memulihkan data, pilih "Import Project". **Tekan dan tahan** di dalam kotak teks lalu pilih 'Tempel' (Paste) untuk memasukkan kode backup Anda, kemudian klik "Import".</li>
                <li><strong>Penting:</strong> Lakukan backup secara berkala untuk menghindari kehilangan data.</li>
            </ul>
        </div>

        <div class="tutorial-section">
            <h3>Export ke PDF</h3>
            <ul>
                <li><strong>Fitur Baru:</strong> Klik tombol "Export ke PDF" di menu samping untuk membuat laporan profesional dalam format PDF.</li>
                <li><strong>Cloud Storage:</strong> PDF akan diunggah ke cloud dan Anda akan mendapat link untuk mengunduh.</li>
                <li><strong>Download Otomatis:</strong> Link yang diberikan akan langsung mengunduh file PDF ke perangkat Anda.</li>
            </ul>
        </div>

        <div class="tutorial-section">
            <h3>Tombol Bantuan Cepat</h3>
            <ul>
                <li><strong>Tombol "💡":</strong> Menampilkan ringkasan jadwal untuk hari ini.</li>
                <li><strong>Tombol Rumah (⌂):</strong> Kembali ke halaman login awal.</li>
                <li><strong>Tombol Quote (💬):</strong> Menampilkan kutipan inspiratif dalam sebuah pop-up.</li>
                <li><strong>Keluar Aplikasi:</strong> Dari menu samping (☰), pilih "Keluar" untuk mencoba menutup tab aplikasi.</li>
            </ul>
        </div>
    </div>
</div>


  <div class="slide" id="editJadwal">
    <div class="button-container">
      <button class="btn btn-edit-save" onclick="saveEditedSchedule()">Simpan</button>
      <button class="btn" onclick="tutupSlide('editJadwal')">Kembali</button>
    </div>
    <h2 id="editJadwalTitle">Edit Jadwal</h2>
    <div class="edit-schedule-container" id="editScheduleContent">
      </div>
  </div>


  <div class="circular-btn home-btn" onclick="kembaliKeLogin()" id="homeBtn" style="display:none" aria-label="Kembali ke Login"></div>
  <div class="circular-btn quote-btn" id="quoteBtn" style="display:none" onclick="showQuotePopup()" aria-label="Tampilkan Kutipan Motivasi"></div>
  <div class="circular-btn tutorial-help-btn" id="tutorialHelpBtn" style="display:none" onclick="showScheduleNow()" aria-label="Lihat Jadwal Hari Ini"></div>
  <div class="circular-btn help-btn" id="helpBtnJadwal" style="display: none;" onclick="showHelp('jadwal')" aria-label="Bantuan Jadwal">?</div>
  <div class="circular-btn help-btn" id="helpBtnKuliah" style="display: none;" onclick="showHelp('kuliah')" aria-label="Bantuan Kuliah">?</div>

  <div class="popup-overlay" id="notificationPopup">
    <div class="popup-content notification-popup">
      <button class="popup-close-btn" onclick="closeNotification()">×</button>
      <h3 class="popup-header" id="notificationTitle">Jadwal Hari Ini</h3>
      <div class="popup-body" id="notificationContent">
        </div>
    </div>
  </div>

  <div class="tutorial-overlay" id="tutorialPopup">
    <div class="tutorial-popup">
      <button class="tutorial-close" onclick="closeMainTutorial()">×</button>
      <h3>Tutorial Penggunaan Aplikasi</h3>
      <p>1. Masukkan nama Anda untuk memulai</p>
      <p>2. Pilih menu Jadwal, lalu tekan tombol <strong>Edit</strong></p>
      <p>3. Di halaman edit, gunakan tombol <strong>⏱️/🗓️</strong> untuk mengganti mode waktu.</p>
      <p>4. Gunakan tombol "💡" di pojok kanan bawah untuk melihat jadwal hari ini.</p>
      <button class="btn" onclick="closeMainTutorial()" style="width:100%; margin-top:15px;">Mengerti</button>
    </div>
  </div>

  <div class="popup-overlay" id="helpPopupOverlay">
    <div class="popup-content" id="helpPopupContent">
      <button class="popup-close-btn" onclick="closeHelpPopup()">×</button>
      <h3 class="popup-header" id="helpPopupTitle">Bantuan</h3>
      <div class="popup-body" id="helpPopupText"></div>
      <div class="popup-footer">
        <button class="btn" onclick="closeHelpPopup()">Tutup</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="kritikSaranPopup">
    <div class="popup-content kritik-saran-popup">
        <button class="popup-close-btn" onclick="closeKritikSaranPopup()">×</button>
        <h3 class="popup-header">Kritik dan Saran</h3>
        <div class="popup-body">
            <textarea id="kritikSaranTextarea" placeholder="Tulis kritik atau saran Anda di sini..."></textarea>
            <div class="feedback-fallback">
                <div class="feedback-container">
                    <span>Jika 'Kirim' gagal, copy & kirim manual:</span>
                    <button class="btn btn-copy-email" onclick="copyEmailToClipboard()">Copy Email</button>
                </div>
            </div>
        </div>
        <div class="popup-footer btn-confirm-container">
            <button class="btn btn-confirm btn-kirim" onclick="sendKritikSaran()">Kirim</button>
            <button class="btn btn-confirm btn-batal" onclick="closeKritikSaranPopup()">Batal</button>
        </div>
    </div>
  </div>


  <div class="popup-overlay" id="resetConfirmPopup">
    <div class="popup-content reset-confirm-popup">
      <span class="question-mark">❓</span>
      <div class="popup-body centered">
         <p>Kamu yakin ingin mereset jadwal kembali ke default?</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmResetYes">Ya</button>
        <button class="btn btn-confirm btn-no" id="confirmResetNo">Tidak</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="deleteConfirmPopup">
    <div class="popup-content delete-confirm-popup">
      <span class="question-mark">🗑️</span>
      <div class="popup-body centered">
         <p>Kamu yakin ingin menghapus item ini?</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmDeleteYes">Ya</button>
        <button class="btn btn-confirm btn-no" id="confirmDeleteNo">Tidak</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="themeConfirmPopup">
    <div class="popup-content theme-confirm-popup">
      <span class="question-mark">🖼️</span>
      <div class="popup-body centered">
         <p>Apakah Anda yakin ingin menerapkan tema ini?</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmThemeYes">Ya</button>
        <button class="btn btn-confirm btn-no" id="confirmThemeNo">Tidak</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="defaultThemeConfirmPopup">
    <div class="popup-content default-theme-confirm-popup">
      <span class="question-mark">ℹ️</span>
      <div class="popup-body centered">
         <p>Anda yakin ingin kembali ke tema awal aplikasi?</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmDefaultThemeYes">Ya</button>
        <button class="btn btn-confirm btn-no" id="confirmDefaultThemeNo">Tidak</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="saveConfirmPopup">
    <div class="popup-content save-confirm-popup">
      <span class="question-mark">💾</span>
      <div class="popup-body centered">
         <p id="saveConfirmMessage">Apakah Anda ingin menyimpan perubahan?</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmSaveYes">Simpan</button>
        <button class="btn btn-confirm btn-no" id="confirmSaveNo">Jangan Simpan</button>
        <button class="btn btn-confirm btn-cancel" id="confirmSaveCancel">Batal</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="exitConfirmPopup">
    <div class="popup-content exit-confirm-popup">
      <span class="question-mark">👋</span>
      <div class="popup-body centered">
         <p>Apakah Anda yakin ingin keluar dari aplikasi?</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmExitYes">Ya, Keluar</button>
        <button class="btn btn-confirm btn-no" id="confirmExitNo">Tidak</button>
      </div>
    </div>
  </div>

  <!-- PDF Confirmation Popup -->
  <div class="popup-overlay" id="pdfConfirmPopup">
    <div class="popup-content pdf-confirm-popup">
      <span class="question-mark">📄</span>
      <div class="popup-body centered">
         <p>Apakah Anda ingin membuat File Pdf laporan Anda? File akan tersimpan secara online dan Anda akan mendapat link untuk mengunduh.</p>
      </div>
      <div class="popup-footer btn-confirm-container">
        <button class="btn btn-confirm btn-yes" id="confirmPdfYes">Siap Buat PDF</button>
        <button class="btn btn-confirm btn-no" id="confirmPdfNo">Batal</button>
      </div>
    </div>
  </div>

  <!-- PDF Success Popup -->
  <div class="popup-overlay" id="pdfSuccessPopup">
    <div class="popup-content pdf-success-popup">
      <button class="popup-close-btn" onclick="closePdfSuccessPopup()">×</button>
      <h3 class="popup-header">✅ PDF Berhasil Diunggah!</h3>
      <div class="popup-body">
        <p>File PDF Anda telah berhasil dibuat . Gunakan link di bawah untuk mengunduh di browser anda (JANGAN CROME):</p>
        <input type="text" id="pdfLinkInput" class="pdf-link-input" readonly>
        <br>
        <a id="pdfDownloadLink" class="pdf-download-link" href="#" onclick="savePdfToDevice(event)">💾 Simpan PDF</a>
        <p style="color: #ff6b35; font-weight: bold; margin-top: 15px;">
          ⚠️ Link PDF ini hanya aktif selama 1 menit. Setelah itu akan otomatis kadaluarsa.
        </p>
      </div>
      <div class="popup-footer">
        <button class="btn" onclick="copyPdfLink()">📋 Salin Link</button>
        <button class="btn" onclick="closePdfSuccessPopup()">Tutup</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="exportPopup">
        <div class="popup-content export-popup">
            <button class="popup-close-btn" onclick="closeExportPopup()">×</button>
            <h3 class="popup-header">📤 Export Data Proyek</h3>
            <div class="popup-body">
                <div class="io-instructions">
                    <h4>Cara Menyimpan Data Anda:</h4>
                    <ol>
                        <li>Klik <strong>"💾 Simpan sebagai File"</strong> untuk langsung menyimpan sebagai file.</li>
                        <li>Atau klik <strong>"Copy Data"</strong> untuk menyalin kode di bawah ini.</li>
                        <li>Buka aplikasi catatan (Notes) di perangkat Anda.</li>
                        <li>Tempel (paste) kode tersebut dan simpan file.</li>
                        <li>Beri nama file yang mudah diingat, misal: <strong>Agendaku_Backup.txt</strong></li>
                    </ol>
                </div>
                <div class="export-data-display" id="exportDataDisplay"></div>
            </div>
            <div class="popup-footer">
                <button class="btn" onclick="saveProjectAsFile()">💾 Simpan sebagai File</button>
                <button class="btn" onclick="copyExportData()">📋 Copy Data</button>
                <button class="btn" onclick="closeExportPopup()">Tutup</button>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="importPopup">
        <div class="popup-content import-popup">
            <button class="popup-close-btn" onclick="closeImportPopup()">×</button>
            <h3 class="popup-header">📥 Import Data Proyek</h3>
            <div class="popup-body">
                <div class="io-instructions">
                    <h4>Cara Memulihkan Data:</h4>
                    <ol>
                        <li>Klik <strong>"📂 Buka dari File"</strong> untuk membuka file backup langsung.</li>
                        <li>Atau salin semua teks dari file backup Anda.</li>
                        <li><strong>Tekan dan tahan</strong> di dalam kotak di bawah lalu pilih 'Tempel' (Paste).</li>
                        <li>Klik tombol <strong>"Import Data"</strong> untuk memulihkan.</li>
                    </ol>
                </div>
                <textarea id="importDataTextarea" placeholder="Tempel (Paste) data backup Anda di sini..."></textarea>
            </div>
            <div class="popup-footer">
                <button class="btn" onclick="openProjectFromFile()">📂 Buka dari File</button>
                <button class="btn" onclick="processImportData()">📥 Import Data</button>
                <button class="btn" onclick="closeImportPopup()">Batal</button>
            </div>
        </div>
    </div>
    
  <div class="popup-overlay" id="quotePopup">
    <div class="popup-content quote-popup-content">
      <button class="popup-close-btn" onclick="closeQuotePopup()">×</button>
      <blockquote>
        <p id="quotePopupText"></p>
        <figcaption id="quotePopupAuthor"></figcaption>
      </blockquote>
    </div>
  </div>

  <div id="agendakuSidebar">
      <div class="sidebar-header">
          <h3>Tentang Agendaku</h3>
          <button class="sidebar-close-btn" onclick="closeAgendakuBranding()">×</button>
      </div>
      <div class="sidebar-content">
          <h4>Agendaku: Pengelola Jadwal Pintar Anda!</h4>
          <p>Aplikasi ini dirancang untuk membantu Anda mengelola waktu dan kegiatan sehari-hari dengan lebih efisien. Fitur-fitur utama termasuk jadwal kegiatan harian, jadwal kuliah/sekolah, catatan pribadi, dan kustomisasi tema.</p>
          <p>Dengan Agendaku, hidup Anda akan lebih terorganisir.</p>

          <h4 class="update-info-toggle" id="updateInfoToggle">Update New Info <span class="arrow">▼</span></h4>
          <div class="update-info-content" id="updateInfoContent">
              <p><strong>Versi 1.6 - PDF Cloud Update:</strong></p>
              <ul>
                  <li><strong>Export PDF ke Cloud:</strong> Fitur baru untuk membuat dan mengunggah laporan PDF ke cloud storage.</li>
                  <li><strong>Download Otomatis:</strong> Link PDF yang dihasilkan akan langsung mengunduh file ke perangkat Anda.</li>
                  <li><strong>Laporan Profesional:</strong> PDF berisi tabel jadwal yang rapi dan terstruktur.</li>
                  <li><strong>Keamanan Data:</strong> Hanya pengguna terdaftar yang dapat menggunakan fitur ini (tidak tersedia untuk mode Tamu).</li>
              </ul>
          </div>

          <div class="sidebar-action-buttons">
              <button class="btn-sidebar-action btn-new-update" onclick="openUpdateInBrowser()">
                  🔥 Cek Update
              </button>
              <button class="btn-sidebar-action btn-export-project" onclick="showExportPopup()">
                  📤 Export Project
              </button>
              <button class="btn-sidebar-action btn-import-project" onclick="showImportPopup()">
                  📥 Import Project
              </button>
              <button class="btn-sidebar-action btn-export-pdf" onclick="showPdfConfirmPopup()">
                  📄 Export ke PDF
              </button>
          </div>
      </div>
      
      <button class="btn-keluar-sidebar" onclick="showExitConfirmPopup()">Keluar</button>

      <div class="social-icons-container">
          <a href="https://www.facebook.com/share/1XPb1Uti5i/" target="_blank" class="social-icon" aria-label="Facebook">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14 13.5h2.5L17 9h-3v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.053-1.6-.144-3.04-.144C10.66 2 9 3.65 9 6.7v2.8H6v4.5h3V22h5v-8.5z"/></svg>
          </a>
          <a href="https://www.instagram.com/aminnu.s?igsh=dWV0bndhYmt6aDI1" target="_blank" class="social-icon" aria-label="Instagram">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4c0 3.2-2.6 5.8-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8C2 4.6 4.6 2 7.8 2zm-.2 2A2.02 2.02 0 0 0 4 6.02V16.2C4 17.65 5.35 19 6.78 19h8.43c1.45 0 2.78-1.35 2.78-2.78V7.8c0-1.45-1.35-2.78-2.78-2.78H7.6zm9.6.48c-.9 0-1.62.73-1.62 1.62s.73 1.62 1.62 1.62c.9 0 1.62-.73 1.62-1.62s-.73-1.62-1.62-1.62zm-4.8 3.7c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 2.5c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/></svg>
          </a>
          <a href="https://andikka0001.github.io/agendaku-komersial/" target="_blank" class="social-icon" aria-label="Website">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v.93zm6.75-3.95c.23-.29.43-.58.62-.89l-1.3-.87c-.33.31-.69.64-1.08.96l1.76.8zm.51-1.28c.36-.59.69-1.2.98-1.84H14v-2h6.13c-.49-1.74-1.83-3.13-3.57-4.04l-1.76.99c.31.29.59.59.86.89l1.45-1.45L12 3.06V2.05c3.08.75 5.51 3.5 6 6.95h-2.1c-.5-1.34-1.49-2.43-2.77-3.14l1.83-1.83c1.7 2 2.77 4.58 2.77 7.42V12h-2.05c-.47-1.16-1.28-2.13-2.31-2.82L16.27 8.5C17.27 9.17 18.06 10.09 18.59 11.1H14V14h4.19c.1-.38.16-.76.16-1.15V12h2.05c-.45-3.08-2.61-5.59-5.38-6.15V3.06L12 2.05v1.01c-3.08.75-5.51 3.5-6 6.95h2.1c.5-1.34 1.49-2.43 2.77-3.14l-1.83-1.83C7.2 6.55 6.13 9.13 6.13 12v.85c.47 1.16 1.28 2.13 2.31 2.82l-1.84 1.84c-1.7-2-2.77-4.58-2.77-7.42V12H3.91C4.36 9.04 6.52 6.53 9.3 5.97V3.06L12 2.05z"/></svg>
          </a>
      </div>
      <div class="sidebar-footer">
          Versi 1.6
      </div>
  </div>

  <input type="file" id="importFileInput" class="hidden-file-input" accept=".json,.txt" onchange="handleImportFile(event)">
  <input type="file" id="customThemeInput" class="hidden-file-input" accept="image/*" onchange="handleCustomTheme(event)">

  <div id="toast-container"></div>
  <audio id="toast-sound" src="https://files.catbox.moe/vxltiz.mp3" preload="auto"></audio>
  <audio id="click-sound" src="https://files.catbox.moe/x35kz3.wav" preload="auto"></audio>

  <script>
    // --- GLOBAL VARIABLES & CONSTANTS ---
    let namaUser = '';
    let nimUser = '';
    let lastLoggedInUser = localStorage.getItem('lastLoggedInUser') || '';
    const DEFAULT_BACKGROUND_IMAGE = 'https://files.catbox.moe/sxim3d.jpg';
    const ADMIN_EMAIL = 'uchihafans2@gmail.com';

    // Supabase Configuration
    const SUPABASE_URL = 'https://nksyeuzkvhdmaqymjpjw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rc3lldXprdmhkbWFxeW1qcGp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4NzI3NDEsImV4cCI6MjA2NzQ0ODc0MX0.bdmVnNDlNxC1QL1vnEVZ9UuwkwX_e0bMQogvQuVCzVE';
    const BUCKET_NAME = 'pdf';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let scheduleCheckerInterval = null;
    let notifiedSchedules = [];
    let pdfDeletionTimeout = null; // For tracking PDF auto-deletion

    // State management variables
    let currentResetContentId = null; 
    let currentEditTargetId = null; 
    let selectedImageTheme = '';
    let currentToastTimeout = null;
    let activeEditableContentId = null; 
    let currentDeleteItemElement = null; 
    let historyState = [];
    let isNavigatingBack = false;

    const appData = {
        jadwalContent: {},
        kuliahContent: {},
        catatanContent: []
    };

    const defaultJadwalData = {
        "Senin": [{ type: "general", time: "Pagi", activity: "Silakan edit kegiatan Anda.", location: "", selesai: false }],
        "Selasa": [{ type: "general", time: "Pagi", activity: "Silakan edit kegiatan Anda.", location: "", selesai: false }],
        "Rabu": [{ type: "general", time: "Pagi", activity: "Silakan edit kegiatan Anda.", location: "", selesai: false }],
        "Kamis": [{ type: "general", time: "Pagi", activity: "Silakan edit kegiatan Anda.", location: "", selesai: false }],
        "Jumat": [{ type: "general", time: "Pagi", activity: "Silakan edit kegiatan Anda.", location: "", selesai: false }],
        "Sabtu": [{ type: "general", time: "Pagi", activity: "Silakan edit kegiatan Anda.", location: "", selesai: false }],
        "Minggu": [{ type: "general", time: "Libur", activity: "Libur", location: "", selesai: false }]
    };

    const defaultKuliahData = {
        "Senin": [{ type: "specific", startTime: "08:00", endTime: "10:00", activity: "Edit Mata Kuliah/Pelajaran", location: "Edit Ruangan", selesai: false }],
        "Selasa": [{ type: "specific", startTime: "09:00", endTime: "11:00", activity: "Edit Mata Kuliah/Pelajaran", location: "Edit Ruangan", selesai: false }],
        "Rabu": [{ type: "specific", startTime: "08:00", endTime: "10:00", activity: "Edit Mata Kuliah/Pelajaran", location: "Edit Ruangan", selesai: false }],
        "Kamis": [{ type: "specific", startTime: "08:00", endTime: "10:00", activity: "Edit Mata Kuliah/Pelajaran", location: "Edit Ruangan", selesai: false }],
        "Jumat": [{ type: "specific", startTime: "08:00", endTime: "10:00", activity: "Edit Mata Kuliah/Pelajaran", location: "Edit Ruangan", selesai: false }],
        "Sabtu": [{ type: "general", time: "Pagi", activity: "Edit Kegiatan Akhir Pekan", location: "", selesai: false }],
        "Minggu": [{ type: "general", time: "Libur", activity: "Libur", location: "", selesai: false }]
    };
    
    const defaultCatatanData = [
        "Tulis catatanmu di sini...",
        "Ini adalah tempat untuk menyimpan ide, daftar tugas, atau informasi penting lainnya.",
        "Coba edit teks ini untuk memulai!"
    ];

    // --- UTILITY FUNCTIONS (Sound, Toast, etc.) ---
    function playSound(soundId) {
      const sound = document.getElementById(soundId);
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.warn('Autoplay audio diblokir:', e));
      }
    }

    function playToastSound() { playSound('toast-sound'); }
    function playClickSound() { playSound('click-sound'); }

    function showToast(title, message, duration = 4000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast-wrapper'; 
      toast.innerHTML = `
        <svg class="bell-icon" viewBox="0 0 24 24">
          <path d="M12 24c1.1 0 1.99-.9 1.99-2H10c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V6c0-.83-.67-1.5-1.5-1.5S10.5 5.17 10.5 6v.68C7.63 7.36 6 9.92 6 13v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <div class="toast-content">
          <strong></strong>
          <span></span>
        </div>
      `;
      toast.querySelector('strong').textContent = title;
      toast.querySelector('span').textContent = message;
      
      while (container.firstChild) {
        container.firstChild.remove();
      }
      if (currentToastTimeout) {
        clearTimeout(currentToastTimeout);
        currentToastTimeout = null;
      }

      container.appendChild(toast);
      setTimeout(() => toast.classList.add('entering'), 10); 
      
      playToastSound();
      currentToastTimeout = setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px) scale(0.9)';
        setTimeout(() => {
          toast.remove();
          currentToastTimeout = null;
        }, 300);
      }, duration);
    }
    
    // NEW: Revised Quotes data structure
    const quotes = [
      { text: "Imajinasi lebih penting daripada pengetahuan.", author: "Albert Einstein" },
      { text: "Satu-satunya cara untuk melakukan pekerjaan hebat adalah dengan mencintai apa yang Anda lakukan.", author: "Steve Jobs" },
      { text: "Orang yang tidak pernah membuat kesalahan tidak pernah mencoba sesuatu yang baru.", author: "Albert Einstein" },
      { text: "Pendidikan adalah senjata paling ampuh yang bisa kamu gunakan untuk mengubah dunia.", author: "Nelson Mandela" },
      { text: "Kesuksesan bukanlah final, kegagalan bukanlah fatal: yang terpenting adalah keberanian untuk melanjutkan.", author: "Winston Churchill" },
      { text: "Percayalah Anda bisa dan Anda sudah setengah jalan.", author: "Theodore Roosevelt" }
    ];

    function getDayNameID(dayIndex) {
      const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
      return days[dayIndex];
    }

    // Generate device ID for PDF naming
    function getDeviceId() {
        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('deviceId', deviceId);
        }
        return deviceId;
    }

    // NEW: Function to open update page in browser (WebView compatible)
    function openUpdateInBrowser() {
        playClickSound();
        const updateUrl = 'https://andikka0001.github.io/agendaku-komersial/';
        
        // Force open in external browser for WebView compatibility
        try {
            // Try to open in new tab/window first
            const newWindow = window.open(updateUrl, '_blank', 'noopener,noreferrer');
            
            // If blocked or in WebView, try alternative methods
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                // Fallback: try to navigate current window
                window.location.href = updateUrl;
            }
        } catch (error) {
            // Final fallback: direct navigation
            window.location.href = updateUrl;
        }
        
        showToast('Membuka Browser', 'Mengarahkan ke halaman update...');
        closeAgendakuBranding();
    }

    // --- ANDROID NATIVE BRIDGE FUNCTIONS ---
    
    // REVISI 1: Integrasi Sistem Notifikasi Canggih
    function handleNotificationScheduling(newData) {
        try {
            // Cek apakah window.Android tersedia
            if (!window.Android || !window.Android.scheduleNotification) {
                console.log('Android bridge tidak tersedia untuk notifikasi');
                return;
            }

            // Iterasi setiap hari dan setiap item jadwal
            for (const day in newData) {
                if (newData[day] && newData[day].length > 0) {
                    newData[day].forEach(item => {
                        // Jika item memiliki type: 'specific' dan startTime
                        if (item.type === 'specific' && item.startTime && item.activity) {
                            // Hitung waktu pemicu untuk kejadian berikutnya
                            const triggerTime = calculateNextTriggerTime(day, item.startTime);
                            
                            if (triggerTime > Date.now()) {
                                // Panggil jembatan native untuk schedule notification
                                const title = `Pengingat: ${item.activity}`;
                                const message = `Waktu untuk ${item.activity}${item.location ? ` di ${item.location}` : ''}`;
                                
                                try {
                                    window.Android.scheduleNotification(title, message, triggerTime);
                                    console.log(`Notifikasi dijadwalkan untuk: ${item.activity} pada ${new Date(triggerTime)}`);
                                } catch (error) {
                                    console.error('Error scheduling notification:', error);
                                }
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error dalam handleNotificationScheduling:', error);
        }
    }

    function calculateNextTriggerTime(dayName, startTime) {
        const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const targetDayIndex = dayNames.indexOf(dayName);
        
        if (targetDayIndex === -1) return 0;
        
        const now = new Date();
        const currentDay = now.getDay();
        
        // Hitung hari berikutnya untuk jadwal tersebut
        let daysUntilTarget = targetDayIndex - currentDay;
        if (daysUntilTarget <= 0) {
            daysUntilTarget += 7; // Minggu berikutnya
        }
        
        // Parse waktu dari string "HH:MM"
        const [hours, minutes] = startTime.split(':').map(Number);
        
        // Buat tanggal target
        const targetDate = new Date(now);
        targetDate.setDate(now.getDate() + daysUntilTarget);
        targetDate.setHours(hours, minutes, 0, 0);
        
        return targetDate.getTime();
    }

    function notifyWelcome() {
        try {
            if (window.Android && window.Android.showWelcomeNotification) {
                window.Android.showWelcomeNotification(
                    "Notifikasi Diaktifkan!", 
                    "Agendaku sekarang akan mengingatkan jadwalmu."
                );
            }
        } catch (error) {
            console.error('Error dalam notifyWelcome:', error);
        }
    }

    // --- REVISED EXPORT/IMPORT FUNCTIONS ---
    function showExportPopup() {
        playClickSound();
        
        const exportData = {
            version: "1.6",
            timestamp: new Date().toISOString(),
            userData: {
                namaUser: namaUser,
                nimUser: nimUser
            },
            appData: {
                jadwalContent: appData.jadwalContent,
                kuliahContent: appData.kuliahContent,
                catatanContent: appData.catatanContent
            },
            preferences: {
                savedTheme: localStorage.getItem(`${namaUser}_savedTheme`) || DEFAULT_BACKGROUND_IMAGE
            }
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        document.getElementById('exportDataDisplay').textContent = dataStr;
        document.getElementById('exportPopup').classList.add('active');
        playToastSound();
        closeAgendakuBranding();
    }

    // REVISI 3: Fitur Export - Simpan sebagai File
    function saveProjectAsFile() {
        playClickSound();
        
        try {
            const dataText = document.getElementById('exportDataDisplay').textContent;
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // Format YYYY-MM-DD
            const defaultFileName = `Agendaku_Backup_${dateStr}.txt`;
            
            if (window.Android && window.Android.saveTextToFile) {
                window.Android.saveTextToFile(dataText, defaultFileName);
                showToast('Berhasil', 'File backup akan disimpan ke perangkat Anda.');
            } else {
                showToast('Tidak Tersedia', 'Fitur ini hanya tersedia di aplikasi Android.');
            }
        } catch (error) {
            console.error('Error saving file:', error);
            showToast('Error', 'Gagal menyimpan file.');
        }
    }

    function copyExportData() {
        playClickSound();
        const dataText = document.getElementById('exportDataDisplay').textContent;
        
        navigator.clipboard.writeText(dataText).then(() => {
            showToast('Berhasil', 'Data backup telah disalin ke clipboard!');
        }).catch(err => {
            showToast('Gagal', 'Gagal menyalin. Silakan salin manual.');
            console.error('Clipboard error:', err);
        });
    }
    
    function closeExportPopup() {
        document.getElementById('exportPopup').classList.remove('active');
    }

    function showImportPopup() {
        playClickSound();
        document.getElementById('importDataTextarea').value = '';
        document.getElementById('importPopup').classList.add('active');
        playToastSound();
        closeAgendakuBranding();
    }

    function closeImportPopup() {
        document.getElementById('importPopup').classList.remove('active');
    }

    // REVISI 3: Fitur Import - Buka dari File
    function openProjectFromFile() {
        playClickSound();
        
        try {
            if (window.Android && window.Android.readTextFromFile) {
                window.Android.readTextFromFile();
                showToast('Memuat...', 'Membuka file selector...');
            } else {
                showToast('Tidak Tersedia', 'Fitur ini hanya tersedia di aplikasi Android.');
            }
        } catch (error) {
            console.error('Error opening file:', error);
            showToast('Error', 'Gagal membuka file.');
        }
    }

    // REVISI 3: Callback untuk hasil baca file dari native
    function onFileRead(content) {
        try {
            if (content && content.trim()) {
                document.getElementById('importDataTextarea').value = content;
                showToast('Berhasil', 'Konten file berhasil dimuat. Klik Import Data untuk melanjutkan.');
            } else {
                showToast('File Kosong', 'File yang dipilih kosong atau tidak valid.');
            }
        } catch (error) {
            console.error('Error in onFileRead:', error);
            showToast('Error', 'Gagal memproses konten file.');
        }
    }

    function processImportData() {
        playClickSound();
        const importText = document.getElementById('importDataTextarea').value.trim();
        
        if (!importText) {
            showToast('Error', 'Silakan tempel (paste) data backup atau buka file terlebih dahulu.');
            return;
        }

        try {
            const importData = JSON.parse(importText);
            
            if (!importData.appData || !importData.userData) {
                throw new Error('Format data tidak valid');
            }

            if (confirm(`Impor data dari backup "${importData.userData.namaUser}"?\n\nPERHATIAN: Ini akan menimpa seluruh data Anda saat ini (${namaUser}).`)) {
                importProject(importData);
                closeImportPopup();
            }
        } catch (error) {
            console.error('Error parsing import data:', error);
            showToast('Error', 'Format data backup tidak valid. Pastikan Anda paste data yang benar.');
        }
    }

    function importProject(importData) {
        try {
            appData.jadwalContent = importData.appData.jadwalContent || JSON.parse(JSON.stringify(defaultJadwalData));
            appData.kuliahContent = importData.appData.kuliahContent || JSON.parse(JSON.stringify(defaultKuliahData));
            appData.catatanContent = importData.appData.catatanContent || [...defaultCatatanData];

            saveData('jadwalContent');
            saveData('kuliahContent');
            saveData('catatanContent');

            if (importData.preferences && importData.preferences.savedTheme) {
                localStorage.setItem(`${namaUser}_savedTheme`, importData.preferences.savedTheme);
                document.body.style.setProperty('--bg-image-url', `url('${importData.preferences.savedTheme}')`);
            }

            renderAllData();
            showToast('Import Berhasil', `Data berhasil dipulihkan & diterapkan.`);
            
        } catch (error) {
            console.error('Error importing project:', error);
            showToast('Error', 'Gagal mengimpor data. Periksa format file.');
        }
    }

    // --- PDF EXPORT FUNCTIONS ---
    function showPdfConfirmPopup() {
        playClickSound();
        if (namaUser === 'Tamu') {
            showToast('Akses Ditolak', 'Fitur Export PDF tidak tersedia untuk mode Tamu. Silakan login dengan nama Anda.');
            return;
        }
        document.getElementById('pdfConfirmPopup').classList.add('active');
        playToastSound();
        closeAgendakuBranding();
    }

    function closePdfConfirmPopup() {
        document.getElementById('pdfConfirmPopup').classList.remove('active');
    }

    function closePdfSuccessPopup() {
        document.getElementById('pdfSuccessPopup').classList.remove('active');
        // Clear deletion timeout if popup is closed manually
        if (pdfDeletionTimeout) {
            clearTimeout(pdfDeletionTimeout);
            pdfDeletionTimeout = null;
        }
    }

    function copyPdfLink() {
        playClickSound();
        const linkInput = document.getElementById('pdfLinkInput');
        navigator.clipboard.writeText(linkInput.value).then(() => {
            showToast('Berhasil', 'Link PDF telah disalin ke clipboard!');
        }).catch(err => {
            showToast('Gagal', 'Gagal menyalin link. Silakan salin manual.');
        });
    }

    // REVISI 3: Fitur Simpan PDF ke Device
    function savePdfToDevice(event) {
        event.preventDefault();
        playClickSound();
        
        try {
            const pdfUrl = document.getElementById('pdfLinkInput').value;
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const defaultFileName = `Agendaku_Laporan_${namaUser}_${dateStr}.pdf`;
            
            if (window.Android && window.Android.downloadAndSavePdf) {
                window.Android.downloadAndSavePdf(pdfUrl, defaultFileName);
                showToast('Mengunduh...', 'PDF sedang diunduh ke perangkat Anda.');
            } else {
                // Fallback: buka di browser
                try {
                    const newWindow = window.open(pdfUrl, '_blank', 'noopener,noreferrer');
                    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                        window.location.href = pdfUrl;
                    }
                } catch (error) {
                    window.location.href = pdfUrl;
                }
            }
        } catch (error) {
            console.error('Error saving PDF:', error);
            showToast('Error', 'Gagal menyimpan PDF.');
        }
    }

    async function generateAndUploadPdf() {
        try {
            showToast('Membuat PDF...', 'Harap tunggu, menyusun laporan profesional...');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageHeight = pdf.internal.pageSize.getHeight();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 15;
            let finalY = 20;

            // --- Judul Utama ---
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(20);
            pdf.text(`Laporan Agendaku`, pageWidth / 2, finalY, { align: 'center' });
            finalY += 8;
            pdf.setFontSize(12);
            pdf.setFont("helvetica", "normal");
            pdf.text(`Pengguna: ${namaUser}`, pageWidth / 2, finalY, { align: 'center' });
            finalY += 15;
            
            // Di bagian header PDF (setelah judul)
pdf.setFontSize(12);
pdf.text(`Dibuat oleh: ${namaUser}`, margin, finalY);
finalY += 5;
pdf.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, margin, finalY);
finalY += 15;

            // Fungsi untuk mengubah data jadwal menjadi format tabel
            const createTableData = (data) => {
                const body = [];
                const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
                daysOrder.forEach(day => {
                    if (data[day] && data[day].length > 0) {
                        data[day].forEach(item => {
                            let timeString = item.type === 'specific' ? `${item.startTime || ''}-${item.endTime || ''}` : `[${item.time || 'Umum'}]`;
                            let activityString = (item.selesai ? '✓ ' : '') + (item.activity || '');
                            body.push([day, timeString, activityString, item.location || '-']);
                        });
                    }
                });
                return body;
            };

            // --- Render Tabel Jadwal Kegiatan ---
            pdf.autoTable({
                startY: finalY,
                head: [['Hari', 'Waktu', 'Kegiatan', 'Lokasi']],
                body: createTableData(appData.jadwalContent),
                theme: 'grid',
                headStyles: { fillColor: [0, 85, 170] },
                didDrawPage: (data) => {
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(16);
                    pdf.text('Jadwal Kegiatan', margin, data.settings.startY - 5);
                }
            });
            finalY = pdf.autoTable.previous.finalY + 15;

            // --- Render Tabel Jadwal Kuliah ---
            if (finalY >= pageHeight - 40) { pdf.addPage(); finalY = margin; }
            pdf.autoTable({
                startY: finalY,
                head: [['Hari', 'Waktu', 'Mata Kuliah/Pelajaran', 'Ruangan']],
                body: createTableData(appData.kuliahContent),
                theme: 'grid',
                headStyles: { fillColor: [0, 85, 170] },
                didDrawPage: (data) => {
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(16);
                    pdf.text('Jadwal Kuliah/Sekolah', margin, data.settings.startY - 5);
                }
            });
            finalY = pdf.autoTable.previous.finalY + 15;

            // --- Render Catatan ---
            if (finalY >= pageHeight - 40) { pdf.addPage(); finalY = margin; }
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.text('Catatan Pribadi', margin, finalY);
            finalY += 8;
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(10);
            const noteLines = pdf.splitTextToSize(appData.catatanContent.join('\n'), pageWidth - (margin * 2));
            pdf.text(noteLines, margin, finalY);

            // --- Tambahkan Footer Nomor Halaman ---
            const pageCount = pdf.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(150);
                pdf.text(`Halaman ${i} dari ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }

            // Convert PDF to blob
const pdfBlob = pdf.output('blob');
const deviceId = getDeviceId();
const now = new Date();
const formattedDate = now.toISOString().split('T')[0]; // Tanggal (YYYY-MM-DD)
const hours = String(now.getHours()).padStart(2, '0'); // Jam (00-23)
const minutes = String(now.getMinutes()).padStart(2, '0'); // Menit (00-59)
const timestamp = `${formattedDate}_${hours}-${minutes}`; // Format: YYYY-MM-DD_HH-MM

const fileName = `pdf/${namaUser}_laporan_${timestamp}.pdf`;
            
            // Upload to Supabase
            const { data, error } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(fileName, pdfBlob, {
                    cacheControl: '0',
                    upsert: true,
                    contentType: 'application/pdf'
                });

            if (error) {
                console.error('Supabase upload error:', error);
                throw new Error(`Upload failed: ${error.message}`);
            }

            // Get public URL
            const { data: urlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(fileName);

            if (!urlData?.publicUrl) {
                throw new Error('Failed to get public URL');
            }

            // Show success popup with download link
            showPdfSuccessPopup(urlData.publicUrl, fileName);

        } catch (error) {
            console.error('PDF generation/upload error:', error);
            showToast('Error', `Gagal membuat atau mengunggah PDF: ${error.message}`);
        }
    }

    function showPdfSuccessPopup(publicUrl, fileName) {
        const linkInput = document.getElementById('pdfLinkInput');
        const downloadLink = document.getElementById('pdfDownloadLink');
        
        linkInput.value = publicUrl;
        downloadLink.href = publicUrl;
        downloadLink.setAttribute('download', `Agendaku_Laporan_${namaUser}.pdf`);
        
        document.getElementById('pdfSuccessPopup').classList.add('active');
        showToast('Berhasil!', 'PDF berhasil diunggah ke cloud. Klik link untuk download.');
        playToastSound();

        // Set 1-minute auto-deletion timer
        pdfDeletionTimeout = setTimeout(async () => {
            try {
                const { error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .remove([fileName]);

                if (error) {
                    console.error('Error deleting PDF:', error);
                } else {
                    showToast('File Kadaluarsa', 'PDF telah otomatis dihapus setelah 1 menit.');
                    closePdfSuccessPopup();
                }
            } catch (error) {
                console.error('Error in auto-deletion:', error);
            }
        }, 65000); // 1 menit + 5 detik
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('guestLoginBtn').addEventListener('click', handleGuestLogin);

      document.getElementById('nama').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('nimInput').focus(); });
      document.getElementById('nimInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
      document.getElementById('confirmResetYes').onclick = () => { playClickSound(); if (currentResetContentId) resetSchedule(currentResetContentId); closeResetConfirmPopup(); };
      document.getElementById('confirmResetNo').onclick = () => { playClickSound(); closeResetConfirmPopup(); };
      document.getElementById('confirmDeleteYes').onclick = () => { playClickSound(); if (currentDeleteItemElement) { currentDeleteItemElement.remove(); showToast('Berhasil', 'Item dihapus.'); currentDeleteItemElement = null; } closeDeleteConfirmPopup(); };
      document.getElementById('confirmDeleteNo').onclick = () => { playClickSound(); currentDeleteItemElement = null; closeDeleteConfirmPopup(); };
      document.getElementById('confirmThemeYes').onclick = () => { playClickSound(); applyTheme(); };
      document.getElementById('confirmThemeNo').onclick = () => { playClickSound(); closeThemeConfirmPopup(); };
      document.getElementById('confirmDefaultThemeYes').onclick = () => { playClickSound(); applyDefaultTheme(); };
      document.getElementById('confirmDefaultThemeNo').onclick = () => { playClickSound(); closeDefaultThemeConfirmPopup(); };
      document.getElementById('confirmSaveYes').onclick = handleSaveConfirmation;
      document.getElementById('confirmSaveNo').onclick = handleDiscardChanges;
      document.getElementById('confirmSaveCancel').onclick = () => { playClickSound(); closeSaveConfirmPopup(); };
      document.addEventListener("DOMContentLoaded", function () {
  const exitButton = document.getElementById("confirmExitYes");
  if (exitButton) {
    exitButton.addEventListener("click", function () {
      exitApplication();
    });
  }
});
      document.getElementById('sidebarOverlay').addEventListener('click', closeAgendakuBranding);
      document.getElementById('updateInfoToggle').addEventListener('click', function() {
          this.classList.toggle('open');
          const content = document.getElementById('updateInfoContent');
          content.style.display = (content.style.display === "block") ? "none" : "block";
      });
      
      document.getElementById('confirmExitYes').onclick = () => { exitApplication(); };
      document.getElementById('confirmExitNo').onclick = () => { playClickSound(); closeExitConfirmPopup(); };

      // PDF confirmation handlers
      document.getElementById('confirmPdfYes').onclick = () => { playClickSound(); closePdfConfirmPopup(); generateAndUploadPdf(); };
      document.getElementById('confirmPdfNo').onclick = () => { playClickSound(); closePdfConfirmPopup(); };

      window.addEventListener('popstate', (e) => { isNavigatingBack = true; handlePopState(e.state); });

      if (lastLoggedInUser) {
        document.getElementById('nama').value = lastLoggedInUser;
        const storedNim = localStorage.getItem(`${lastLoggedInUser}_nim`);
        if (storedNim) document.getElementById('nimInput').value = storedNim;
      }
      
      loadSavedTheme();
      updateCircularButtonVisibility('login');
      updateDigitalClock();
      setInterval(updateDigitalClock, 1000);
      if (document.getElementById('login').style.display !== 'none') {
          pushState('login');
      }
    });

    // --- USER & DATA MANAGEMENT (MULTI-USER SUPPORT) ---
    function loadUserData(username) {
        const savedJadwal = localStorage.getItem(`${username}_jadwalContent`);
        appData.jadwalContent = savedJadwal ? JSON.parse(savedJadwal) : JSON.parse(JSON.stringify(defaultJadwalData));
        
        const savedKuliah = localStorage.getItem(`${username}_kuliahContent`);
        appData.kuliahContent = savedKuliah ? JSON.parse(savedKuliah) : JSON.parse(JSON.stringify(defaultKuliahData));
        
        const savedCatatan = localStorage.getItem(`${username}_catatanContent`);
        appData.catatanContent = savedCatatan ? JSON.parse(savedCatatan) : [...defaultCatatanData];

        renderAllData();
    }

    function renderAllData() {
        renderJadwal(appData.jadwalContent, 'jadwalContent');
        renderJadwal(appData.kuliahContent, 'kuliahContent');
        renderCatatan(appData.catatanContent);
    }

    function saveData(key) {
        if (!namaUser) return;
        localStorage.setItem(`${namaUser}_${key}`, JSON.stringify(appData[key]));
    }
    
    function renderJadwal(data, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const fragment = document.createDocumentFragment();
        
        let hasContent = false;
        for (const day in data) {
            if (data[day] && data[day].length > 0) {
              hasContent = true;
              const h3 = document.createElement('h3');
              h3.textContent = `${day}:`;
              const ul = document.createElement('ul');
            
              data[day].forEach((item, index) => {
                  const li = document.createElement('li');
                  li.className = item.selesai ? 'selesai' : '';

                  const checkbox = document.createElement('div');
                  checkbox.className = 'jadwal-checkbox';
                  checkbox.setAttribute('onclick', `toggleSelesai('${containerId}', '${day}', ${index})`);

                  const teksJadwal = document.createElement('span');
                  teksJadwal.className = 'jadwal-teks';

                  let timeString = '-:';
                  if (item.type === 'specific' && item.startTime && item.endTime) {
                       timeString = `${item.startTime.replace(':', '.')}-${item.endTime.replace(':', '.')}:`;
                  } else if (item.type === 'general' && item.time) {
                      timeString = `${item.time}:`;
                  }
                  
                  const locationString = item.location ? `<span class="location-text">(${item.location})</span>` : '';

                  if (item.activity === "Libur" && item.time === "Libur") {
                      teksJadwal.innerHTML = 'Libur';
                  } else {
                      teksJadwal.innerHTML = `<strong>${timeString}</strong> ${item.activity || ''} ${locationString}`;
                  }

                  li.appendChild(checkbox);
                  li.appendChild(teksJadwal);
                  ul.appendChild(li);
              });
              fragment.appendChild(h3);
              fragment.appendChild(ul);
            }
        }

        if (!hasContent) {
            const emptyMsg = document.createElement('p');
            emptyMsg.className = 'jadwal-empty';
            emptyMsg.textContent = 'Belum ada jadwal. Klik "Edit" untuk menambahkan.';
            fragment.appendChild(emptyMsg);
        }
        container.appendChild(fragment);
    }

    function renderCatatan(data) {
        const container = document.getElementById('catatanContent');
        container.innerHTML = '';
        const fragment = document.createDocumentFragment();
        if (data && data.length > 0 && (data.length > 1 || data[0] !== '')) {
            data.forEach(line => {
                const p = document.createElement('p');
                p.textContent = line;
                fragment.appendChild(p);
            });
        } else {
            const emptyMsg = document.createElement('p');
            emptyMsg.className = 'jadwal-empty';
            emptyMsg.textContent = 'Belum ada catatan. Klik "Edit" untuk menambahkan.';
            fragment.appendChild(emptyMsg);
        }
        container.appendChild(fragment);
    }
    
    function toggleSelesai(contentId, hari, index) {
        playClickSound();
        const item = appData[contentId]?.[hari]?.[index];
        if (!item) return;

        item.selesai = !item.selesai;

        if (item.selesai) {
            showToast('Selamat!', `Anda sudah menyelesaikan: "${item.activity}"`);
        }

        saveData(contentId);
        renderJadwal(appData[contentId], contentId);
    }

    // --- HISTORY & NAVIGATION ---
    function pushState(slideId, contentId = null) {
        const state = { slideId, contentId };
        history.pushState(state, '', `#${slideId}`);
        historyState.push(state);
    }
    
    // REVISI 2: Modifikasi fungsi handlePopState
    function handlePopState(state) {
        const activePopup = document.querySelector('.popup-overlay.active, .tutorial-overlay.active, #agendakuSidebar.active');
        if(activePopup) {
            if (activePopup.id.includes('Popup') || activePopup.id.includes('tutorial')) activePopup.classList.remove('active');
            if (activePopup.id === 'agendakuSidebar') closeAgendakuBranding();
            history.pushState(historyState[historyState.length-1], '', `#${historyState[historyState.length-1].slideId}`);
            return;
        }

        // REVISI 2: Ganti logika backPressOnLoginCount
        if (historyState.length === 1 && historyState[0].slideId === 'login') {
            showExitConfirmPopup();
            history.pushState({ slideId: 'login' }, '', '#login');
            return;
        }

        if (historyState.length > 1) {
            historyState.pop();
            const previousState = historyState[historyState.length - 1];
            navigateTo(previousState.slideId, previousState.contentId, false);
        } else {
             kembaliKeLogin();
        }
        isNavigatingBack = false;
    }

    function navigateTo(slideId, contentId = null, pushToHistory = true) {
        document.querySelectorAll('.overlay.active, .slide.active').forEach(el => el.classList.remove('active'));
        
        setTimeout(() => {
            document.querySelectorAll('.overlay, .slide').forEach(el => el.style.display = 'none');
            const targetElement = document.getElementById(slideId);
            if (targetElement) {
                targetElement.style.display = 'flex';
                setTimeout(() => targetElement.classList.add('active'), 10);
            }
            if (pushToHistory) pushState(slideId, contentId);
            
            updateCircularButtonVisibility(slideId);
            document.getElementById('helpBtnJadwal').style.display = (slideId === 'jadwal') ? 'flex' : 'none';
            document.getElementById('helpBtnKuliah').style.display = (slideId === 'kuliah') ? 'flex' : 'none';

            if (slideId === 'editJadwal' && contentId) {
                currentEditTargetId = contentId;
                loadScheduleToEditor();
            } else if (slideId === 'editCatatan') {
                document.getElementById('editCatatanTextarea').value = appData.catatanContent.join('\n');
            }
        }, 300);
    }
    
    function bukaSlide(slideId, contentId = null) {
      playClickSound();
      if (slideId === 'editCatatan') {
          showToast('Mode Edit', 'Catatan Anda sekarang dapat diubah.');
      }
      navigateTo(slideId, contentId);
    }

    function tutupSlide(slideId) {
        playClickSound();
        let shouldPromptSave = false;
        let message = '';

        if (slideId === 'editJadwal') {
            const editorData = buildScheduleDataFromEditor();
            if (JSON.stringify(editorData) !== JSON.stringify(appData[currentEditTargetId])) {
                shouldPromptSave = true;
                message = `Anda punya perubahan yang belum disimpan. Simpan perubahan?`;
            }
        } else if (slideId === 'editCatatan') {
            if (document.getElementById('editCatatanTextarea').value !== appData.catatanContent.join('\n')) {
                shouldPromptSave = true;
                message = 'Anda punya perubahan yang belum disimpan di catatan. Simpan perubahan?';
            }
        } else if (slideId === 'instruksi') {
            navigateTo('info', null, false);
            return;
        } else if (slideId === 'ubahTema') {
            // Auto-close theme panel and return to menu
            navigateTo('menu', null, false);
            return;
        }

        if (shouldPromptSave) {
            activeEditableContentId = slideId;
            document.getElementById('saveConfirmMessage').textContent = message;
            document.getElementById('saveConfirmPopup').classList.add('active');
            playToastSound();
            return;
        }

        if (historyState.length > 1) history.back();
        else goToMenu();
    }
    
    // --- CORE APP LOGIC ---
    function handleLogin() {
        const inputNama = document.getElementById('nama').value.trim();
        if (!inputNama) {
            showToast('Peringatan', 'Silakan masukkan nama Anda terlebih dahulu.');
            return;
        }
        const inputNim = document.getElementById('nimInput').value.trim();
        loginUser(inputNama, inputNim);
    }

    function handleGuestLogin() {
        loginUser('Tamu', '');
    }

    function loginUser(name, nim) {
        namaUser = name;
        nimUser = nim;
        
        localStorage.setItem('lastLoggedInUser', namaUser);
        if (namaUser !== 'Tamu') {
            localStorage.setItem(`${namaUser}_nim`, nim);
        }

        loadUserData(namaUser);
        loadSavedTheme();

        const loginBtn = document.getElementById('loginBtn');
        loginBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
            loginBtn.style.transform = 'scale(1)';
            navigateTo('menu');
            
            const displayName = (namaUser === 'Tamu') ? '-' : namaUser;
            const displayNim = nimUser ? `Nim/Kelas: ${nimUser}` : (namaUser === 'Tamu' ? 'Mode Tamu' : 'Nim/Kelas: -');
            
            document.getElementById('userNameDisplayMenu').textContent = displayName;
            document.getElementById('userNimDisplayMenu').textContent = displayNim;
            document.getElementById('userInfoDisplayMenu').style.display = 'block';
            document.getElementById('namaInfo').textContent = `Nama: ${displayName}`;
            document.getElementById('nimInfo').textContent = displayNim;

            showToast('Selamat Datang!', `Halo ${namaUser}, Aplikasi Agendaku siap digunakan.`);
            if (!localStorage.getItem('hasSeenTutorial')) {
                showMainTutorial();
                localStorage.setItem('hasSeenTutorial', 'true');
            }
            requestNotificationPermissionAndStartChecker();
        }, 200);
    }

    function kembaliKeLogin() {
      playClickSound();
      if (scheduleCheckerInterval) {
          clearInterval(scheduleCheckerInterval);
          scheduleCheckerInterval = null;
      }
      
      document.querySelectorAll('.popup-overlay.active, .sidebar-overlay-blur.active, #agendakuSidebar.active').forEach(el => {
          el.classList.remove('active');
      });

      namaUser = '';
      nimUser = '';

      navigateTo('login');
      updateCircularButtonVisibility('login');
    }
    
    function goToMenu() {
        navigateTo('menu');
    }

    // --- UNIFIED SCHEDULE EDITOR LOGIC ---
    function loadScheduleToEditor() {
        const editorContainer = document.getElementById('editScheduleContent');
        editorContainer.innerHTML = ''; 
        const fragment = document.createDocumentFragment();
        const data = appData[currentEditTargetId];
        const title = currentEditTargetId === 'jadwalContent' ? 'Edit Jadwal Kegiatan' : 'Edit Jadwal Kuliah/Sekolah';
        document.getElementById('editJadwalTitle').textContent = title;

        for(const day in data) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'edit-schedule-group';
            groupDiv.innerHTML = `<h3>${day}:</h3>`;
            
            if (data[day] && data[day].length > 0) {
                data[day].forEach(item => {
                    const itemDiv = createEditorItem(item);
                    groupDiv.appendChild(itemDiv);
                });
            }
            
            groupDiv.appendChild(createAddNewEntry(day));
            fragment.appendChild(groupDiv);
        }
        editorContainer.appendChild(fragment);
    }
    
    function createEditorItem(item) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'edit-schedule-item';
        const type = (item.type === 'specific' || item.type === 'general') ? item.type : 'general';
        itemDiv.dataset.timeType = type;

        const generalTimes = ["", "Shubuh", "Pagi", "Dhuhur", "Siang", "Ashar", "Sore", "Maghrib", "Isya", "Malam", "Libur"];
        const options = generalTimes.map(t => `<option value="${t}" ${item.time === t ? 'selected' : ''}>${t || 'waktu tidak ditentukan'}</option>`).join('');

        itemDiv.innerHTML = `
            <div class="edit-schedule-inputs">
                <div class="time-input-container">
                    <div class="time-input-container-general">
                        <select class="time-selector">${options}</select>
                    </div>
                    <div class="time-input-container-specific">
                        <input type="time" class="start-time-input" value="${item.startTime || ''}">
                        <span>-</span>
                        <input type="time" class="end-time-input" value="${item.endTime || ''}">
                    </div>
                </div>
                <div class="description-input-container">
                    <input type="text" class="activity-input" placeholder="Deskripsi Kegiatan..." value="${item.activity || ''}">
                    <input type="text" class="location-input" placeholder="Tempat (Opsional)" value="${item.location || ''}">
                </div>
            </div>
            <div class="item-controls">
                <button class="toggle-time-type-btn" title="Ubah Mode Waktu"></button>
                <button class="add-item-btn" title="Tambah Item Baru">➕</button>
                <button class="delete-item-btn" title="Hapus Item">🗑️</button>
            </div>
        `;
        
        itemDiv.querySelector('.toggle-time-type-btn').addEventListener('click', function() { toggleTimeInput(this); });
        itemDiv.querySelector('.add-item-btn').addEventListener('click', function() { addItem(this); });
        itemDiv.querySelector('.delete-item-btn').addEventListener('click', function() { confirmDeleteItem(this); });

        updateTimeInputVisibility(itemDiv);
        return itemDiv;
    }
    
    function toggleTimeInput(button) {
        playClickSound();
        const itemDiv = button.closest('.edit-schedule-item');
        const currentType = itemDiv.dataset.timeType;
        itemDiv.dataset.timeType = (currentType === 'general') ? 'specific' : 'general';
        updateTimeInputVisibility(itemDiv);
    }

    function updateTimeInputVisibility(itemDiv) {
        const type = itemDiv.dataset.timeType;
        const generalContainer = itemDiv.querySelector('.time-input-container-general');
        const specificContainer = itemDiv.querySelector('.time-input-container-specific');
        const toggleBtn = itemDiv.querySelector('.toggle-time-type-btn');

        if (type === 'specific') {
            generalContainer.style.display = 'none';
            specificContainer.style.display = 'flex';
            toggleBtn.textContent = '🗓️';
            toggleBtn.title = "Ubah ke Waktu Umum";
        } else { // 'general'
            generalContainer.style.display = 'flex';
            specificContainer.style.display = 'none';
            toggleBtn.textContent = '⏱️';
            toggleBtn.title = "Ubah ke Jam Spesifik";
        }
    }

    function createAddNewEntry(day) {
        const newEntryDiv = document.createElement('div');
        newEntryDiv.className = 'add-new-entry';
        newEntryDiv.innerHTML = `<input type="text" placeholder="Tambah kegiatan baru..."><button>Tambah</button>`;
        newEntryDiv.querySelector('button').addEventListener('click', function() { addNewEntry(this, day); });
        return newEntryDiv;
    }

    function addNewEntry(button, day) {
        playClickSound();
        const newEntryContainer = button.closest('.add-new-entry');
        const textInput = newEntryContainer.querySelector('input[type="text"]');
        if (!textInput.value.trim()) {
            showToast('Peringatan', 'Isi deskripsi entri baru terlebih dahulu.');
            return;
        }

        const newItemData = { type: 'general', time: 'Pagi', activity: textInput.value.trim(), location: '', selesai: false };
        const newItemDiv = createEditorItem(newItemData);
        newEntryContainer.parentNode.insertBefore(newItemDiv, newEntryContainer);
        textInput.value = '';
        showToast('Berhasil', 'Entri baru ditambahkan.');
    }

    function addItem(button) {
        playClickSound();
        const itemDiv = button.closest('.edit-schedule-item');
        const newItemData = { type: 'general', time: '', activity: '', location: '', selesai: false };
        const newItemDiv = createEditorItem(newItemData);
        itemDiv.parentNode.insertBefore(newItemDiv, itemDiv.nextSibling);
        newItemDiv.querySelector('.activity-input').focus();
        showToast('Berhasil', 'Item baru ditambahkan.');
    }

    function buildScheduleDataFromEditor() {
        const editorContainer = document.getElementById('editScheduleContent');
        const newData = {};
        const oldData = appData[currentEditTargetId];

        editorContainer.querySelectorAll('.edit-schedule-group').forEach(groupDiv => {
            const day = groupDiv.querySelector('h3').textContent.replace(':', '');
            newData[day] = [];
            let originalIndexCounter = 0;
            groupDiv.querySelectorAll('.edit-schedule-item').forEach(itemDiv => {
                const activityInput = itemDiv.querySelector('.activity-input');
                const locationInput = itemDiv.querySelector('.location-input');

                if (activityInput && (activityInput.value.trim() || itemDiv.dataset.timeType === 'general' && itemDiv.querySelector('.time-selector').value === 'Libur')) {
                    const type = itemDiv.dataset.timeType;
                    const oldItem = oldData?.[day]?.[originalIndexCounter] || { selesai: false };
                    
                    let newItem = {
                        type: type,
                        activity: activityInput.value.trim(),
                        location: locationInput.value.trim(),
                        selesai: oldItem.selesai 
                    };

                    if (type === 'general') {
                        newItem.time = itemDiv.querySelector('.time-selector').value;
                    } else { // 'specific'
                        newItem.startTime = itemDiv.querySelector('.start-time-input').value;
                        newItem.endTime = itemDiv.querySelector('.end-time-input').value;
                    }
                    newData[day].push(newItem);
                    originalIndexCounter++;
                }
            });
        });
        return newData;
    }

    // REVISI 1: Modifikasi fungsi saveEditedSchedule
    function saveEditedSchedule() {
        playClickSound();
        const newData = buildScheduleDataFromEditor();
        appData[currentEditTargetId] = newData;
        saveData(currentEditTargetId);
        
        renderJadwal(newData, currentEditTargetId);
        
        // REVISI 1: Tambahkan panggilan handleNotificationScheduling setelah saveData
        handleNotificationScheduling(newData);
        
        showToast('Berhasil', 'Jadwal berhasil diperbarui.');
        
        // Immediate return to schedule view (100ms instead of 1000ms)
        setTimeout(() => {
            if (currentEditTargetId === 'jadwalContent') {
                navigateTo('jadwal');
            } else if (currentEditTargetId === 'kuliahContent') {
                navigateTo('kuliah');
            }
        }, 100);
    }
    
    function handleSaveConfirmation() {
        playClickSound();
        if (activeEditableContentId === 'editCatatan') {
            saveCatatan();
        } else if (activeEditableContentId === 'editJadwal') {
            saveEditedSchedule();
        }
        closeSaveConfirmPopup();
        
        if (activeEditableContentId === 'editCatatan') {
            if (historyState.length > 1) history.back();
            else goToMenu();
        }
    }

    function handleDiscardChanges() {
        playClickSound();
        showToast('Info', 'Perubahan tidak disimpan.');
        closeSaveConfirmPopup();
        if (historyState.length > 1) history.back();
        else goToMenu();
    }
    
    function closeSaveConfirmPopup() {
        document.getElementById('saveConfirmPopup').classList.remove('active');
    }

    function saveCatatan() {
        playClickSound();
        const newContent = document.getElementById('editCatatanTextarea').value;
        appData.catatanContent = newContent.split('\n');
        saveData('catatanContent');
        renderCatatan(appData.catatanContent);
        showToast('Tersimpan', 'Catatan pribadi berhasil diperbarui.');
        
        // Navigate back properly without closing tabs
        if (historyState.length > 1) {
            history.back();
        } else {
            navigateTo('catatan');
        }
    }
    
    function confirmResetSchedule(contentId) {
      playClickSound();
      currentResetContentId = contentId;
      document.getElementById('resetConfirmPopup').classList.add('active');
      playToastSound();
    }

    function resetSchedule(contentId) {
        if (contentId === 'jadwalContent') appData.jadwalContent = JSON.parse(JSON.stringify(defaultJadwalData));
        if (contentId === 'kuliahContent') appData.kuliahContent = JSON.parse(JSON.stringify(defaultKuliahData));
        saveData(contentId);
        renderJadwal(appData[contentId], contentId);
        showToast('Reset Berhasil', 'Jadwal telah kembali ke pengaturan awal.');
    }

    function closeResetConfirmPopup() {
      document.getElementById('resetConfirmPopup').classList.remove('active');
      currentResetContentId = null;
    }

    function confirmDeleteItem(button) {
        playClickSound();
        currentDeleteItemElement = button.closest('.edit-schedule-item');
        document.getElementById('deleteConfirmPopup').classList.add('active');
        playToastSound();
    }

    function closeDeleteConfirmPopup() {
        document.getElementById('deleteConfirmPopup').classList.remove('active');
        currentDeleteItemElement = null;
    }

    function showScheduleNow() {
      playClickSound();
      const dayName = getDayNameID(new Date().getDay());
      const dailyActivities = appData.jadwalContent[dayName] || [];
      const schoolActivities = appData.kuliahContent[dayName] || [];
      let kegiatanHtml = `<div class="no-schedule-message">Tidak ada kegiatan terjadwal.</div>`;
      let kuliahHtml = `<div class="no-schedule-message">Tidak ada jadwal kuliah.</div>`;

      const renderItemToHtml = (item) => {
          let timeString = '-:';
          if (item.type === 'specific' && item.startTime && item.endTime) {
              timeString = `${item.startTime.replace(':', '.')}-${item.endTime.replace(':', '.')}:`;
          } else if (item.type === 'general' && item.time) {
              timeString = `${item.time}:`;
          }

          const locationString = item.location ? `<span class="location-text">(${item.location})</span>` : '';
          const fullText = `<strong>${timeString}</strong> ${item.activity || ''} ${locationString}`;

          if (item.activity === "Libur" && item.time === "Libur") return '<li>Libur</li>';
          
          if (item.selesai) {
              return `<li class="popup-selesai">✅ <span class="popup-jadwal-teks">${fullText}</span></li>`;
          } else {
              return `<li>${fullText}</li>`;
          }
      };
      
      const validDaily = dailyActivities.filter(item => item.activity && item.activity !== 'Silakan edit kegiatan Anda.');
      if (validDaily.length > 0) {
          kegiatanHtml = '<ul>' + validDaily.map(renderItemToHtml).join('') + '</ul>';
      }
      
      const validSchool = schoolActivities.filter(item => item.activity && !item.activity.includes('Mata Kuliah/Pelajaran'));
      if (validSchool.length > 0) {
          kuliahHtml = '<ul>' + validSchool.map(renderItemToHtml).join('') + '</ul>';
      }
      
      document.getElementById('notificationContent').innerHTML = `
        <div class="jadwal-group"><h4>Kegiatan Harian (${dayName}):</h4>${kegiatanHtml}</div>
        <div class="jadwal-group"><h4>Kuliah/Sekolah (${dayName}):</h4>${kuliahHtml}</div>`;
      document.getElementById('notificationPopup').classList.add('active');
      playToastSound();
    }
    
    function closeNotification() {
      playClickSound();
      document.getElementById('notificationPopup').classList.remove('active');
    }

    function showMainTutorial() {
      document.getElementById('tutorialPopup').style.display = 'flex';
      playToastSound();
    }

    function closeMainTutorial() {
      playClickSound();
      document.getElementById('tutorialPopup').style.display = 'none';
    }

    function confirmImageTheme(imageUrl) {
      playClickSound();
      selectedImageTheme = imageUrl;
      document.getElementById('themeConfirmPopup').classList.add('active');
      playToastSound();
    }
    
    function triggerCustomTheme() {
        playClickSound();
        document.getElementById('customThemeInput').click();
    }

    function handleCustomTheme(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const imageDataUrl = e.target.result;
            selectedImageTheme = imageDataUrl;
            document.getElementById('themeConfirmPopup').classList.add('active');
            playToastSound();
        }
        reader.readAsDataURL(file);
        event.target.value = ''; // Reset input
    }

    function applyTheme() {
      document.body.style.setProperty('--bg-image-url', `url('${selectedImageTheme}')`); 
      localStorage.setItem(`${namaUser}_savedTheme`, selectedImageTheme);
      showToast('Berhasil', 'Tema berhasil diganti.');
      closeThemeConfirmPopup();
      
      // Auto-close theme panel and return to menu
      setTimeout(() => {
          navigateTo('menu');
      }, 1000);
    }

    function closeThemeConfirmPopup() {
      document.getElementById('themeConfirmPopup').classList.remove('active');
      selectedImageTheme = '';
    }

    function confirmDefaultTheme() {
      playClickSound();
      document.getElementById('defaultThemeConfirmPopup').classList.add('active');
      playToastSound();
    }

    function applyDefaultTheme() {
      document.body.style.setProperty('--bg-image-url', `url('${DEFAULT_BACKGROUND_IMAGE}')`); 
      localStorage.removeItem(`${namaUser}_savedTheme`);
      showToast('Berhasil', 'Tema latar belakang kembali ke default.');
      closeDefaultThemeConfirmPopup();
      
      // Auto-close theme panel and return to menu
      setTimeout(() => {
          navigateTo('menu');
      }, 1000);
    }

    function closeDefaultThemeConfirmPopup() {
      document.getElementById('defaultThemeConfirmPopup').classList.remove('active');
    }
    
    // NEW: Function to show aesthetic quote popup
    function showQuotePopup() {
        playClickSound();
        
        const randomIndex = Math.floor(Math.random() * quotes.length);
        const randomQuote = quotes[randomIndex];
        
        document.getElementById('quotePopupText').textContent = randomQuote.text;
        document.getElementById('quotePopupAuthor').textContent = `— ${randomQuote.author}`;
        
        const popup = document.getElementById('quotePopup');
        popup.classList.add('active');
        playToastSound(); // Reusing the sound for a nice effect
    }

    function closeQuotePopup() {
        playClickSound();
        document.getElementById('quotePopup').classList.remove('active');
    }
    
    function updateCircularButtonVisibility(activeSlideId) {
        const isMenuVisible = activeSlideId === 'menu';
        const displayStyle = isMenuVisible ? 'flex' : 'none';

        document.getElementById('homeBtn').style.display = displayStyle;
        document.getElementById('quoteBtn').style.display = displayStyle;
        document.getElementById('tutorialHelpBtn').style.display = displayStyle;

        const isLoginOrMenuVisible = (activeSlideId === 'login' || activeSlideId === 'menu');
        document.querySelector('.menu-icon-top-right').style.display = isLoginOrMenuVisible ? 'flex' : 'none';
    }

    function updateDigitalClock() {
      const now = new Date();
      const dateString = now.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
      const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
      const fullDateTimeString = `${dateString.replace(/,/g, '')} | ${timeString}`;
      document.getElementById('digitalClock').textContent = fullDateTimeString;
      if (document.getElementById('digitalClockMenu')) document.getElementById('digitalClockMenu').textContent = fullDateTimeString;
    }

    function showHelp(slideId) {
      playClickSound();
      let title = "Bantuan";
      let contentHtml = '';
      if (slideId === 'jadwal' || slideId === 'kuliah') {
        title = "Bantuan: Mengelola Jadwal";
        contentHtml = `<p>Di sini Anda bisa mengelola jadwal Anda secara fleksibel.</p>
                       <ul>
                         <li><strong>Edit Jadwal:</strong>  Klik "Edit" untuk mengubah item, menambah, atau menghapus.</li>
                         <li><strong>Mode Waktu Fleksibel:</strong> Di halaman edit, gunakan tombol ⏱️/🗓️ untuk beralih antara input 'Jam Spesifik' dan 'Waktu Umum' untuk setiap kegiatan.</li>
                         <li><strong>Input Tempat:</strong> Isi kolom 'Tempat (Opsional)' untuk menambahkan detail lokasi.</li>
                         <li><strong>Reset Jadwal:</strong> Tombol "Reset" akan mengembalikan jadwal ke pengaturan awal.</li>
                         <li><strong>Melihat Jadwal Hari Ini:</strong> Gunakan tombol "💡" untuk ringkasan jadwal hari ini.</li>
                       </ul>`;
      }
      document.getElementById('helpPopupTitle').textContent = title;
      document.getElementById('helpPopupText').innerHTML = contentHtml;
      document.getElementById('helpPopupOverlay').classList.add('active');
      playToastSound();
    }

    function closeHelpPopup() {
      playClickSound();
      document.getElementById('helpPopupOverlay').classList.remove('active');
    }

    function loadSavedTheme() {
      const savedTheme = localStorage.getItem(`${namaUser}_savedTheme`);
      const themeUrl = savedTheme || DEFAULT_BACKGROUND_IMAGE;
      document.body.style.setProperty('--bg-image-url', `url('${themeUrl}')`);
    }

    function showKritikSaranPopup() {
      playClickSound();
      document.getElementById('kritikSaranTextarea').value = ''; 
      document.getElementById('kritikSaranPopup').classList.add('active');
      playToastSound();
    }

    function closeKritikSaranPopup() {
      playClickSound();
      document.getElementById('kritikSaranPopup').classList.remove('active');
    }

    function sendKritikSaran() {
      playClickSound();
      const kritikSaranText = document.getElementById('kritikSaranTextarea').value.trim();
      if (kritikSaranText === '') {
        showToast('Peringatan', 'Silakan isi kritik atau saran Anda terlebih dahulu.');
        return;
      }
      const subject = encodeURIComponent('Kritik dan Saran Aplikasi Agendaku');
      const body = encodeURIComponent(`Dari Pengguna: ${namaUser}\nNIM/Kelas: ${nimUser || 'Tidak Ada'}\n\n${kritikSaranText}`);
      window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
      showToast('Membuka Email', 'Silakan kirim dari aplikasi email Anda.');
      closeKritikSaranPopup();
    }
    
    function copyEmailToClipboard() {
        playClickSound();
        navigator.clipboard.writeText(ADMIN_EMAIL).then(() => {
            showToast('Berhasil', 'Alamat email disalin ke clipboard.');
        }).catch(err => {
            showToast('Gagal', 'Tidak dapat menyalin alamat email.');
        });
    }

    function showAgendakuBranding() {
        playClickSound();
        document.getElementById('sidebarOverlay').classList.add('active');
        document.getElementById('agendakuSidebar').classList.add('active');
        document.querySelector('.menu-icon-top-right').style.opacity = '0';
    }

    function closeAgendakuBranding() {
        playClickSound();
        document.getElementById('sidebarOverlay').classList.remove('active');
        document.getElementById('agendakuSidebar').classList.remove('active');
        document.querySelector('.menu-icon-top-right').style.opacity = '1';
    }

    function showExitConfirmPopup() {
        playToastSound();
        document.getElementById('exitConfirmPopup').classList.add('active');
    }
    function closeExitConfirmPopup() {
        document.getElementById('exitConfirmPopup').classList.remove('active');
    }
    
    // REVISI 2: Modifikasi fungsi exitApplication
    function exitApplication() {
    playClickSound();
    closeExitConfirmPopup();

    if (typeof Android !== "undefined" && Android.exitApp) {
        Android.exitApp();
    } else {
        showToast('Fitur Tidak Tersedia', 'Fitur keluar aplikasi hanya tersedia di Android.');
    }
}

    const timeRanges = {
        "Shubuh": { start: 4, end: 6, title: "Waktunya Shubuh!" },
        "Pagi": { start: 7, end: 11, title: "Selamat Pagi!" },
        "Dhuhur": { start: 12, end: 14, title: "Waktunya Dhuhur!" },
        "Ashar": { start: 15, end: 17, title: "Waktunya Ashar!" },
        "Maghrib": { start: 18, end: 19, title: "Waktunya Maghrib!" },
        "Isya": { start: 19, end: 21, title: "Waktunya Isya!" },
        "Malam": { start: 21, end: 23, title: "Selamat Malam!" }
    };

    function showBrowserNotification(title, body) {
        if (Notification.permission === 'granted') {
            new Notification(title, {
                body: body,
                icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'
            });
        }
    }

    function checkCurrentSchedule() {
        const now = new Date();
        const currentDayName = getDayNameID(now.getDay());
        const currentHour = now.getHours();
        const currentTime = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });

        const allTodaySchedules = [
            ...(appData.jadwalContent[currentDayName] || []),
            ...(appData.kuliahContent[currentDayName] || [])
        ];

        allTodaySchedules.forEach(item => {
            if (item.selesai) return;

            if (item.type === 'specific' && item.startTime) {
                const uniqueId = `${currentDayName}-${item.startTime}-${item.activity}`;
                if (item.startTime === currentTime && !notifiedSchedules.includes(uniqueId)) {
                    showBrowserNotification("Pengingat Jadwal", `Saatnya untuk: ${item.activity}`);
                    notifiedSchedules.push(uniqueId);
                }
            }
        });
        
        for (const period in timeRanges) {
            const range = timeRanges[period];
            if (currentHour >= range.start && currentHour < range.end) {
                const uniquePeriodId = `${currentDayName}-${period}`;
                
                if (!notifiedSchedules.includes(uniquePeriodId)) {
                    const activitiesInPeriod = allTodaySchedules
                        .filter(item => item.type === 'general' && item.time === period && !item.selesai)
                        .map(item => item.activity);
                    
                    if (activitiesInPeriod.length > 0) {
                        const notificationBody = "Jangan lupa: " + activitiesInPeriod.join(', ');
                        showBrowserNotification(range.title, notificationBody);
                    }
                    
                    notifiedSchedules.push(uniquePeriodId);
                }
            }
        }
    }

    function startScheduleChecker() {
        notifiedSchedules = []; 
        if (scheduleCheckerInterval) {
            clearInterval(scheduleCheckerInterval);
        }
        scheduleCheckerInterval = setInterval(checkCurrentSchedule, 60000); 
    }

    // REVISI 1: Modifikasi fungsi requestNotificationPermissionAndStartChecker
    function requestNotificationPermissionAndStartChecker() {
        if (!('Notification' in window)) {
            console.log("Browser ini tidak mendukung notifikasi desktop.");
            return;
        }

        if (Notification.permission === 'granted') {
            // REVISI 1: Tambahkan panggilan notifyWelcome() sebelum startScheduleChecker()
            notifyWelcome();
            startScheduleChecker();
        } else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    // REVISI 1: Tambahkan panggilan notifyWelcome() sebelum startScheduleChecker()
                    notifyWelcome();
                    showToast('Notifikasi Diaktifkan', 'Pengingat jadwal akan muncul jika ada.');
                    startScheduleChecker();
                }
            });
        }
    }

  </script>

<!-- Pop-up Sambutan Elegan -->
<div class="popup-overlay" id="welcomePopup">
  <div class="popup-content welcome-popup-content">
    <button class="popup-close-btn" onclick="closeWelcomePopupAndRefresh()">×</button>
    <h2>👋 Selamat Datang di Agendaku!</h2>
    <p>
      Terima kasih telah memilih <strong>Agendaku</strong> sebagai teman harianmu.
      Yuk atur jadwalmu dan mulai hari dengan lebih terencana!
    </p>
    <button class="btn btn-welcome" onclick="closeWelcomePopupAndRefresh()">Masuk Sekarang</button>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const welcomePopup = document.getElementById("welcomePopup");
    if (!localStorage.getItem("popup_shown")) {
      welcomePopup.classList.add("active");
    }
  });

  function closeWelcomePopupAndRefresh() {
    localStorage.setItem("popup_shown", "true");
    location.reload(true);
  }
</script>

</body>
</html>